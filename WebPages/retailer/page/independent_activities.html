<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no" name="format-detection" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no" />
    <title>自主活动</title>
    <link href="../css/weixintips.css" rel="stylesheet" />
    <link rel="stylesheet" href="/retailer/css/retailerstyle.css" />
    <link href="../css/independent_activities.css" rel="stylesheet" />
    <link href="../css/default.css" rel="stylesheet" />
    <link href="../css/default.date.css" rel="stylesheet" />
    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/retailer\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script src="../../js/jquery/iscroll.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
    <style>
        .xiugai {
            height: 160px;
            width: 100%;
            overflow: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        input[type='date'], input[type='text'], input[type='submit'], input[type='button'], input[type='number'], select, select option, textarea, button {
            -webkit-appearance: none;
        }
    </style>
</head>

<body>

    <div class="container add">
        <div class="a-title" onclick="activity.create()">创建新活动</div>
        <div class="clear"></div>
        <i>消费者一般在平台审核通过后的第二天看到您的活动</i>
    </div>

    <!--创建-->
    <div id="create">

    </div>

    <div id="list">

    </div>

    <div id="bottom-nav"></div>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/wx/configinit.js"></script>
    <script type="text/javascript" src="/retailer/js/lib/common.js"></script>
    <script type="text/javascript" src="/js/jquery/toastr.min.js"></script>
    <script src="../js/lib/picker.js"></script>
    <script src="../js/lib/picker.date.js"></script>
    <script src="/retailer/js/common-buttom-nav.js"></script>
    <script>
        $(function () {
            activity.list();
            $(document).on('input','#zt_text',function(){
              var this_val=$(this).val();
              var regEx = new RegExp(/^(([^\^\.<>%&',;=?$"':#@!~\]\[{}\\/`\|])*)$/);
              var result = this_val.match(regEx);
              alert(result);
              if(result==null){
                  var b = $(this).val().replace(/[ ]/g,"");
                  $(this).val(b);
              }
            })
        });
        var cssObj = {
            tabChange: function (t, obj) {
                if ($(obj).is(".curr"))
                    return;
                var parentObj = $(obj).closest("table");
                if (t == 0) {
                    $(obj).parent().find("input[name=reltype]").val(0);
                    parentObj.find("tr[data-type=1]").hide();
                    parentObj.find("tr[data-type=0]").show();
                }
                else {
                    $(obj).parent().find("input[name=reltype]").val(1);
                    parentObj.find("tr[data-type=0]").hide();
                    parentObj.find("tr[data-type=1]").show();
                }
                parentObj.find(".curr").removeClass("curr");
                $(obj).addClass("curr");
            },
            noAuditShow: function (t, obj) {
                t == 0 ? $(obj).parent().next().show() : $(obj).parent().hide();
            }
        }
        var popup = {
            show: function (t, callback) {
                var cont = "";
                if (t == 1)
                    cont = '<div class="win-box"><p><img src="../image/activities/tl-4.png"  style="width:37px" /></p><p>您是否确定删除此活动？</p><p style="margin-top:20px;"><input type="button" class="w-save" id="del-btn" value="确定" /><input class="w-cancel" onclick="popup.close()" type="button" value="取消" /></p></div>';
                else if (t == 2)
                    cont = '<div class="win-box"><p><img src="../image/activities/tl-5.png"  style="width:40px"  /></p><p>网络异常，请重试！</p><p style="margin-top:20px;"><input type="button" class="w-save" value="确定" /><input class="w-cancel" onclick="popup.close()" type="button" value="取消" /></p></div>';
                else if (t == 3)
                    cont = '<div class="win-box"><p><img src="../image/activities/tl-6.png" style="width:32px"  /></p><p>您还有内容未保存！<br/>退出后将清空，确定要退出？</p><p style="margin-top:20px;"><input type="button" class="w-save" value="确定" /><input class="w-cancel" onclick="popup.close()" type="button" value="取消" /></p></div>';
                else if (t == 4)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-6.png" /></p><p>该活动刚刚完成审核<br/>如要修改，请先下架！</p></p><div class="win-close" ></div></div>';
                else if (t == 5)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-6.png"  /></p><p> 该活动刚刚完成审核，且未通过！<br/>请到未发布活动列表中修改。</p></p><div class="win-close"></div></div>';
                else if (t == 6)
                    cont = '<div class="win-box"><p><img src="../image/activities/tl-6.png" style="width:32px"  /></p><p>该活动已在审核中<br/>将很快与惠粉见面，确认要修改？</p><p style="margin-top:20px;"><input type="button" class="w-save" value="确定" /><input class="w-cancel" onclick="popup.close()" type="button" value="取消" /></p></div>';
                else if (t == 7)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-8.png"  /></p><p style="color:#000">保存成功</p><p style="color:#999">请到未发布活动列表查看</p></p><div class="win-close"></div></div>';
                else if (t == 8)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-8.png"  /></p><p style="color:#000">发布成功</p><p  style="color:#999">请到已发布活动列表查看</p><div class="win-close" "></div></div>';
                else if (t == 9)
                    cont = '<div class="win-box"><p><img src="../image/activities/tl-6.png" style="width:32px"  /></p><p>确定下架？<br/>下架后惠粉将看不到您的活动</p><p style="margin-top:20px;"><input type="button" class="w-save" value="确定" /><input class="w-cancel" onclick="popup.close()" type="button" value="取消" /></p></div>';
                else if (t == 10)
                    cont = '<div class="win-box date-box" style="position:fixed;"><div class="xiugai" ><ul class="huadonga"><li >00</li><li >01</li><li >02</li><li >03</li><li >04</li><li >05</li><li >06</li><li >07</li><li >08</li><li >09</li><li >10</li><li >11</li><li >12</li><li >13</li><li >14</li><li>15</li><li >16</li><li >17</li><li >18</li><li >19</li><li >20</li><li >21</li><li >22</li><li >23</li></ul></div><p style="margin-top:20px;"><input class="date-btn" onclick="popup.close()" type="button" value="取消" /><input type="button" class="date-btn" value="确定" id="date-save" style="margin-left:10px;" /></p></div>';
                else if (t == 11)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-6.png" /></p><p>该活动刚刚完成审核<br/>如要删除，请先下架！</p></p></div><div class="win-close" ></div>';
                else if (t == 12)
                    cont = '<div class="win-box win-6" style="position: fixed;"><p><img src="../image/activities/tl-8.png"  /></p><p style="color:#000">下架成功</p><p  style="color:#999">请到未发布活动列表查看</p></div><div class="win-close" "></div>';
                else if (t == 13)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-6.png"  /></p><p> 该活动刚刚完成审核，且未通过！<br/>请到未发布活动列表中删除。</p></p><div class="win-close"></div></div>';
                else if (t == 14)
                    cont = '<div class="win-box win-6"><p><img src="../image/activities/tl-6.png"  /></p><p> 该活动刚刚完成审核！<br/>请到未发布活动列表中删除。</p></p><div class="win-close"></div></div>';
                $("body").css("padding-bottom", "0");
                $('#lazyout').remove();
                $('#win_box').remove();
                $("body").append('<div class="lazyout" id="lazyout" style="position:fixed;"></div><div id="win_box">' + cont + '</div>');

                var h = $(window).height() > $(document.body).height() ? $(window).height() : $(document.body).height();
                //$("#lazyout ").height(h);
               // var winH = ($(window).height() - $("#win_box .win-box").outerHeight()) / 2 + $(document).scrollTop() - 25;
                $(window).bind("touchmove", function (e) {
                     e.preventDefault();
                })
                $('.xiugai').bind("touchmove", function (e) {
                    e.stopPropagation();
                })
                $("body").css("overflow", "hidden");
                //$("#win_box .win-box").css("top", winH);
                //$("#win_box .win-close").css("top", winH + $("#win_box .win-box").outerHeight() + 50);
                $("#win_box .w-save,#win_box .win-close").click(function () {
                    popup.close();
                    if (callback != null)
                        callback();
                })


               // myScroll = new IScroll('#wrapper', { mouseWheel: true, click: true });
                //$(".win-close").click(function () {
                //    popup.close();
                //    if (callback != null)
                //        callback();
                //})
            },

            close: function () {
                $("body").css("padding-bottom", "60px")
                $("body").css("overflow", "visible")
                $("#lazyout,#win_box").remove();
                $(window).unbind("touchmove");
            }

        };
        function initDate() {

            // $("input[name=originalprice]").on('keydown',function () {
            // 	// alert(1);
            //     var originalprice = $(this).val();
            //     if (!$.isNumeric(originalprice) || originalprice <= 0) {
            //         $(this).val("");
            //         return;
            //     }

            //     originalprice = new Number(originalprice).toFixed(2);
            //     if(originalprice.length<=7){
            //     	$(this).val(originalprice);
            //     }
            //     var discountprice = new Number($(this).parent().find("input[name=discountprice]").val());
            //     $(this).parent().find(".d-cont").text(getDiscount(discountprice, originalprice));
            // });


            // // $("input[name=discountprice]").blur(function () {
            // $("input[name=discountprice]").on('keydown',function () {
            //     var discountprice = $(this).val();
            //     // var discountprice = $(this).val();
            //     if (!$.isNumeric(discountprice) || discountprice <= 0) {
            //         $(this).val("");
            //         return;
            //     }
            //     discountprice = new Number(discountprice).toFixed(2);
            //     $(this).val(discountprice);
            //     var originalprice = new Number($(this).parent().find("input[name=originalprice]").val());

            //     $(this).parent().find(".d-cont").text(getDiscount(discountprice, originalprice));
            // });

            $("input[name=originalprice]").on('input',function (){

                if(!isNaN(this.value)){
                    // console.log(this.value.indexOf("."));
                    if(this.value.indexOf(".")!=-1){

                        $(this).attr('maxlength',"7");

                        if(this.value.substring(this.value.indexOf(".")).length > 3){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                        if(this.value.indexOf(".")==5){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        } else if(this.value.indexOf(".")==6){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                    } else if(this.value.indexOf(".")==-1){
                        $(this).attr('maxlength',"7");
                    }

                } else {
                    alert("请录入整数或小数");
                    // popup.show(11);
                    $(this).val("");
                }

                // console.log(this.value);

                if (this.value < 0) {
                    this.value = "";
                    // $(this).val("");
                    // return;
                } else if(this.value.indexOf("-")!=-1){
                    this.value = "";
                    // $(this).val('');
                }

                var discountprice = new Number($(this).parent().find("input[name=discountprice]").val());
                $(this).parent().find(".d-cont span").text(getDiscount(discountprice, this.value));

            });


            // $("input[name=discountprice]").blur(function () {
            $("input[name=discountprice]").on('input',function () {
                if(!isNaN(this.value)){

                    if(this.value.indexOf(".")!=-1){

                        $(this).attr('maxlength',"7")
                        // this.value=this.value.slice(0,10)

                        if(this.value.substring(this.value.indexOf(".")).length > 3){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                        if(this.value.indexOf(".")==5){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        } else if(this.value.indexOf(".")==6){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                    } else if(this.value.indexOf(".")==-1){
                        $(this).attr('maxlength',"7");
                    }

                } else {
                    alert("请录入整数或小数");
                    // popup.show(11);
                    // popup.show(10);
                    $(this).val("");
                }

                // console.log(this.value);

                if (this.value < 0) {
                    // $(this).val("");
                    this.value = "";
                    // return;
                } else if(this.value.indexOf("-")!=-1){
                    // $(this).val('');
                    this.value = "";
                }

                var originalprice = new Number($(this).parent().find("input[name=originalprice]").val());
                $(this).parent().find(".d-cont span").text(getDiscount(this.value, originalprice));

            });


            // $("input[name=unitprice]").blur(function () {
            $("input[name=unitprice],input[name=buycount],input[name=giftcount]").on('input',function () {
                // alert('dsdsds')
                if(!isNaN(this.value)){

                    if(this.value.indexOf(".")!=-1){

                        $(this).attr('maxlength',"7")
                        // this.value=this.value.slice(0,10)

                        if(this.value.substring(this.value.indexOf(".")).length > 3){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                        if(this.value.indexOf(".")==5){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        } else if(this.value.indexOf(".")==6){
                            this.value = this.value.substring(0,this.value.indexOf('.')+3)
                        }

                    } else if(this.value.indexOf(".")==-1){
                        $(this).attr('maxlength',"7");
                    }

                } else {
                    alert("请录入整数或小数");
                    // popup.show(11);
                    // popup.show(10);
                    $(this).val("");
                }

                // console.log(this.value);

                if (this.value < 0) {
                    // $(this).val("");
                    this.value = "";
                    // return;
                } else if(this.value.indexOf("-")!=-1){
                    // $(this).val('');
                    this.value = "";
                }

            });


            function getDiscount(specialprice, originalcost) {
                console.log(originalcost/specialprice);
                if (specialprice > 0 && originalcost > 0) {
                    if(originalcost > specialprice)
                    {
                        var discount = originalcost/specialprice;
                        //优惠价除以原价 保留一位小数点
                        var disc = parseFloat(discount).toFixed(1);
                        //console.log(disc);
                        //var disc = discount.substring(0, discount.lastIndexOf('.') + 2);

                        if (disc == null) {
                            disc = "";
                        }
                    }else
                    {
                        alert("原价必须大于优惠价!!!");
                        $("input[name=discountprice]").val("");
                    }
                    // alert(disc);
                    return disc;
                }
                return "";
            }
            var todaysDate = new Date();
             $("input[name=begintime]").val(todaysDate.getFullYear() + "-" + (todaysDate.getMonth() + 1) + "-" + todaysDate.getDate());
            // $('.date').pickadate({ min: Date.now });
            $('input[name=begintime]').pickadate({ min: Date.now });
            var todaysDate = new Date();
            $("input[name=endtime]").val(todaysDate.getFullYear() + "-" + (todaysDate.getMonth() + 1) + "-" + (todaysDate.getDate() + 1));

           $("input[name=endtime]").pickadate({
                min: Date.now,
                onSet: function(thingSet) {
                    // picker.set('highlight', '2016-10-28', { format: 'yyyy-mm-dd' });
                    // console.log(Date.now);
                    var et = new Date(parseInt(thingSet.select) * 1).toLocaleDateString().replace(/\//g,'-');
                    if(et < $("input[name=begintime]").val()){
                        toasterextend.showtips("结束时间建议大于今天", "error");
                    }
                }
            });

           /*
            //if($("input[name=begintime]").val()==""){
                var myDate = new Date();
                var today = myDate.toLocaleDateString();
                $("input[name=begintime]").val(today.replace(/\//g, '-'));
            //}


            //if($("input[name=endtime]").val()==""){
                $("input[name=endtime]").val(new Date((new Date() * 1) + (86400000 * 1)).toLocaleDateString().replace(/\//g, '-'));
            //}
            */
            /*else {
            }*/

            if($(".date-hour").val()=="" || $(".date-hour").val()=="NaN"){
                $(".date-hour").val("00");
            }

            $('.date-hour').click(function () {
                var parent = this;
                popup.show(10);
                $("#win_box li").click(function () {
                    $("#win_box .curr").removeClass("curr");
                    $(this).addClass("curr");
                    //$("#win_box .xiugai").scroll();
                });
                $("#win_box ul").scroll(function (stop) {
                    var top = $(this).scrollTop();
                    var h = Math.ceil(top / 50);
                    $("#win_box .curr").removeClass("curr");
                    $($("#win_box li:eq(" + h + ")")).addClass("curr");
                });
                $("#date-save").click(function () {
                    $(parent).val($("#win_box .curr").text());
                    popup.close();
                })
            });

            $(".create textarea").keyup(function () {
                $(this).next().text($(this).val().length + "/" + $(this).attr("maxlength"));
            });

        }

        function intToZH(num)
        {
            var zh = ["零", "一", "二", "三", "四", "五", "六", "七", "八", "九"];
            var  unit = ["", "十", "百", "千", "万", "十", "百", "千", "亿", "十"];
            var str = "";
            var sb = num;
            if (parseInt(num) > 10000)
            {
                return num;
            }
            sb = sb.split("").reverse().join("");
            var r = 0;
            var l = 0;
            for (var j = 0; j < sb.length; j++)
            {
               r = parseInt(sb.substring(j, j+1));

               if (j != 0)
                   l = parseInt(sb.substring(j-1, j));

               if (j == 0)
               {
                  if (r != 0 || sb.length == 1)
                      str = zh[r];
                  continue;
               }

               if (j == 1 || j == 2 || j == 3 || j == 5 || j == 6 || j == 7 || j == 9)
               {
                   if (r != 0)
                       str = zh[r] + unit[j] + str;
                   else if (l != 0)
                       str = zh[r] + str;
                   continue;
                }

               if (j == 4 || j == 8)
               {
                   str =  unit[j] + str;
                   if ((l != 0 && r == 0) || r != 0)
                       str = zh[r] + str;
                   continue;
               }
            }
            if (str.indexOf("百") >= 0) {
                return str;
            } else {
                return str.replace("一十", "十");
            }

        }

        function convertformtoedit(obj, json){

            $(obj.parentNode.parentNode).hide();
            $(obj).closest(".relitem").after(createHtml);

            initDate();

            var fm = $(obj).closest(".relitem").next();
            fm.find(".a-title").text("编辑活动");
            var relType = (json.type == "markdown" ? 0 : 1);
            fm.find("input[name=activityid]").val(json.activityid);
            fm.find("input[name=reltype]").val(relType);

            fm.find("textarea[name=goodsname]").val(json.goodsname);
            var storedDate = new Date(json.begintime);
            var todaysDate = new Date();
            if (storedDate >= todaysDate)
                fm.find("input[name=begintime]").val(json.begintime);
            else
                fm.find("input[name=begintime]").val(todaysDate.getFullYear() + "-" + (todaysDate.getMonth() + 1) + "-" + todaysDate.getDate());

            var endTime = new Date(json.endtime + ":00:00");
            /*if (endTime >= todaysDate)
                fm.find("input[name=endtime]").val(endTime.getFullYear() + "-" + (endTime.getMonth() + 1) + "-" + endTime.getDate());
            else
                fm.find("input[name=endtime]").val(todaysDate.getFullYear() + "-" + (todaysDate.getMonth() + 1) + "-" + todaysDate.getDate());*/

            var a = json.endtime.substring(0,10);
            var etimestamp = new Date(a).getTime();
            // console.log(etimestamp);

            var today = new Date() * 1;
            if(today > etimestamp){
                var tomorrow = new Date(today + (86400000 * 1)).toLocaleDateString().replace(/\//g, '-')
                json.endtime = tomorrow;
            }

            fm.find("input[name=endtime]").val(json.endtime.substring(0,10));
            fm.find("input[name=datehour]").val(endTime.getHours());
            fm.find("textarea[name=remark]").val(json.remark);

            if (relType == 0) {
                if(json.discount == null){
                    json.discount = "";
                }

                fm.find("input[name=originalprice]").val(json.originalprice);
                fm.find("input[name=discountprice]").val(json.discountprice);
                // alert(json.discount);
                fm.find(".dis-box .d-cont span").text(json.discount);
                fm.find("tr[data-type=1]").hide();
                fm.find("tr[data-type=0]").show();

            } else {
                fm.find("input[name=unitprice]").val(json.unitprice);
                fm.find("input[name=buycount]").val(json.buycount);
                fm.find("input[name=giftcount]").val(json.giftcount);
                fm.find("tr[data-type=0]").hide();
                fm.find("tr[data-type=1]").show();
            }

            fm.find(".a-type .curr").removeClass("curr");
            fm.find(".a-type a:eq(" + relType + ")").addClass("curr");
            fm.find("textarea[name=goodsname]").next().text(fm.find("textarea[name=goodsname]").val().length + "/" + fm.find("textarea[name=goodsname]").attr("maxlength"))
            fm.find("textarea[name=remark]").next().text(fm.find("textarea[name=remark]").val().length + "/" + fm.find("textarea[name=remark]").attr("maxlength"));

        }

        var isValid = false;
        var length = 0;
        var activity = {
            //查询数据
            list: function () {
                _ajax("GET", "/webapi/retailer/owner/activities/",null, function (json) {
                    if (json.activities.length == 0)
                        return;
                    var releaseHtml = "";
                    var noReleaseHtml = "";
                    var noReleaseCount = 0;
                    var releaseCount = 0;
                    $.each(json.activities, function (i, item) {
                        if ($.trim(item.state) == "未发布" || $.trim(item.state) == "审核失败" || $.trim(item.state) == "下架")
                        {
                            noReleaseHtml += activity.getRelHtml(item);
                            noReleaseCount += 1;
                        }
                        else
                        {
                            releaseHtml += activity.getRelHtml(item);
                            releaseCount += 1;
                        }
                    });
                    var htmlContent = noReleaseCount > 0 ? '<div class="container no-release"> <div class="a-title">未发布的活动</div>' + noReleaseHtml + '</div>' : '';
                    htmlContent = releaseCount > 0 ? htmlContent + '<div class="container release"><div class="a-title">已发布进行中的活动</div>' + releaseHtml + '</div>' : htmlContent;

                    $("#list").html(htmlContent);

                    //$("#list").html('<div class="container no-release"> <div class="a-title">未发布的活动</div>' + noReleaseHtml + '</div> <div class="container release"><div class="a-title">已发布进行中的活动</div>' + releaseHtml + '</div>');
                });

            },

            getRelHtml: function (item) {
                var content = "";
                var state = $.trim(item.state);
                var isMarkDown = false;
                if ($.trim(item.type) == "markdown")
                    isMarkDown = true;

                content += '<div class="relitem" ' + (state == "上架" ? 'style="padding-bottom:0"' : '') + '>'
                        + '<table cellpadding="0" cellspacing="0">'
                        + '<tr><td colspan="2" class="ft17"><label class="cut">' + (isMarkDown ? "降价" : "买赠") + '</label><span class="goodsname" style="width: 69%;display: inline-block;">' + item.goodsname+'</span>';

                if (state == "审核中")
                    content += '<label class="auit">审核中</label>';
                else if (state == "上架")
                    content += '<label class="released">已发布</label>';

                if (state=="审核失败"){
                    if(item.reason != null && $.trim(item.reason).length > 0) {
                        content += '<div class="no-audit"><b></b><div class="n-title">该活动审核未通过<a href="javascript:;" onclick="cssObj.noAuditShow(0,this)">查看原因</a></div>'
                        + '<div class="n-cont">' + item.reason + '<div class="n-close" onclick="cssObj.noAuditShow(1,this)"></div></div></div>';
                    }else
                    {
                        content += '<div class="no-audit"><b></b><div class="n-title">该活动审核未通过<a href="javascript:;" onclick="cssObj.noAuditShow(0,this)">查看原因</a></div>'
                      + '<div class="n-cont">' + "" + '<div class="n-close" onclick="cssObj.noAuditShow(1,this)"></div></div></div>';
                    }
                }
                content += "</td></tr>";

                if (isMarkDown){

                    if(item.originalprice == undefined || item.originalprice == null || item.originalprice == "NaN" )
                        item.originalprice = "";
                    if(item.discountprice == undefined || item.discountprice == null || item.discountprice == "NaN")
                        item.discountprice = "";
                    if(item.discount == undefined || item.discount == null || item.discount == "NaN")
                        item.discount = "";
                    if (item.discount == "NaN"|| item.discount=="") {
                        content += '<tr><th>原&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：</th><td>￥<span class="originalPrice">' + parseFloat(item.originalprice) + '</span></td></tr>'
                            + '<tr><th>优&nbsp;&nbsp;惠&nbsp;&nbsp;价：</th><td>￥<span class="discountPrice">' + parseFloat(item.discountprice) + '</span></td></tr>'
                            + '<tr><th>折&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;扣：</th><td><span class="disCount">' + 0 + '</span>折</td></tr>';
                    } else {
                        content += '<tr><th>原&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：</th><td>￥<span class="originalPrice">' + parseFloat(item.originalprice) + '</span></td></tr>'
                             + '<tr><th>优&nbsp;&nbsp;惠&nbsp;&nbsp;价：</th><td>￥<span class="discountPrice">' + parseFloat(item.discountprice) + '</span></td></tr>'
                             + '<tr><th>折&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;扣：</th><td><span class="disCount">' + parseFloat(item.discount) + '</span>折</td></tr>';
                    }


                } else {

                    if(item.unitprice == undefined || item.unitprice == null || item.unitprice == "NaN")
                        item.unitprice = "";
                        // alert(item.unitprice);
                    if(item.buycount == undefined || item.buycount == null || item.buycount == "NaN")
                        item.buycount = "";

                    if(item.giftcount == undefined || item.giftcount == null || item.giftcount == "NaN")
                        item.giftcount = "";

                    content += '<tr><th>单&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价：</th><td>￥<span class="unitPrice">' + parseFloat(item.unitprice) + '</span></td></tr>'
                             + '<tr><th>买&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;赠：</th><td><span class="buyCount">' + '</span>买<span class="giftCount">' + intToZH(item.buycount) + '</span>赠<span class="giftCount">' + intToZH(item.giftcount) + '</span></td></tr>';
                }


                //if(state == "未发布"){

                //    var bdate = item.begintime.replace(/-/g,'/');
                //    var btimestamp = new Date(bdate).getTime();

                //    var today = new Date() * 1;

                //    if(today > btimestamp){
                //        var d = new Date(today);
                //        var date = (d.getFullYear()) + "-" +
                //                   (d.getMonth() + 1) + "-" +
                //                   (d.getDate()) + " "
                //        item.begintime = date;
                //    }

                //    var a = item.endtime.substring(0,10);
                //    var etimestamp = new Date(a).getTime();
                //    // console.log(etimestamp);

                //    if(today > etimestamp){
                //        var tomorrow = new Date((new Date() * 1) + (86400000 * 1)).toLocaleDateString().replace(/\//g, '-')
                //        item.endtime = tomorrow;
                //    }

                //}



                content += '<tr><th>活动时间：</th><td><span class="beginTime">' + item.begintime + '</span> 至 <span class="endTime">' + item.endtime + '</span></td></tr>'
                         + '<tr><th valign="top">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</th><td valign="top"><span class="bz" style="    display: block;   word-wrap: break-word;    word-break: break-all;">' + item.remark + '</span></td></tr>';

                if ($.trim(item.state) == "未发布") {
                    content += '</table><ul class="op-pnl" data-code=' + item.activityid + ' data-state='+item.state+'><li onclick="activity.del(this)"><label class="op-del">删除</label></li><li onclick="activity.edit(this)" id="zt_xiugai"><label class="op-update" >修改</label></li>';
                    if (item.reason != null && $.trim(item.reason).length > 0) {
                        content += '<li onclick="activity.updateState(\'up\',this)">';
                        content += '<label class="op-release">发布</label></li></ul><div class="clear"></div>';
                    }
                    else {
                        content += '<li onclick="activity.updateState(\'up\',this)">';
                        content += '<label class="op-release">发布</label></li></ul><div class="clear"></div>';
                    }

                }
                else if ($.trim(item.state) == "审核失败")
                 {
                    content += '</table><ul class="op-pnl" data-code=' + item.activityid + ' data-state=' + item.state + '><li onclick="activity.del(this)"><label class="op-del">删除</label></li><li onclick="activity.edit(this)"><label class="op-update" >修改</label></li>';
                   if (item.reason != null && $.trim(item.reason).length > 0) {
                       content += '<li onclick="activity.updateState(\'up\',this)">';
                       content += '<label class="op-release">发布</label></li></ul><div class="clear"></div>';
                   }
                   else {
                       content += '<li onclick="activity.updateState(\'up\',this)">';
                       content += '<label class="op-release">发布</label></li></ul><div class="clear"></div>';
                   }
                } else if ($.trim(item.state) == "下架")
                {
                    content += '</table><ul class="op-pnl" data-code=' + item.activityid + ' data-state=' + item.state + '><li onclick="activity.del(this)"><label class="op-del">删除</label></li><li onclick="activity.edit(this)"><label class="op-update" >修改</label></li>';
                    content += '<li onclick="activity.updateState(\'up\',this)">';
                    content += '<label class="op-release">上架</label></li></ul><div class="clear"></div>';
                }
                else if ($.trim(item.state) == "审核中")
                    content += '</table><ul class="op-pnl" data-code=' + item.activityid + ' data-state=' + item.state + ' ><li style="width:50%;"  onclick="activity.del(this)""><label class="op-del">删除</label></li><li style="width:50%;" onclick="activity.edit(this)"><label class="op-update">修改</label></li><div class="clear"></div>';
                else if ($.trim(item.state) == "上架")
                    content += '<tr><td colspan="2" align="center" style="height:45px;"  data-code="' + item.activityid + '" data-state=' + item.state + '><input  type="button" onclick="activity.stateDown(this)" value="下架" class="ots-btn" /></td></tr> </table>';
                    content += "</div>";

                return content;

            },

            //删除
            del: function (obj) {
                var activityid = $(obj.parentNode).attr("data-code");
                var state = $(obj.parentNode).attr("data-state");
                _ajax("GET", '/webapi/retailer/owner/activities/' + $(obj).parent().attr("data-code"), null, function (json) {
                        if (json.state == "上架") {
                            popup.show(14, null);
                            return;
                        }
                        else {
                            if (json.state == state) {
                                popup.show(1, function () { });
                                $('#del-btn').click(function () {
                                    if (json.activityid == activityid)
                                        _ajax("DELETE", '/webapi/retailer/activities/' + activityid, null, function (json) {
                                            activity.delRelItem($(obj).parent().parent());
                                            window.location.reload();
                                        });
                                })
                            }
                            else
                            {
                                popup.show(13, null);
                                return;
                            }

                        }
                    })
            },
            delRelItem: function (obj) {
                if ($(obj).parent().find(".relitem").length == 1)
                    $(obj).parent().remove();
                else
                    $(obj).remove();
            },
            create: function () {
                $("#create").prepend(createHtml);
                initDate();
            },

            //新增
            add: function (obj, t) {
                console.log(obj+t)
                var createObj = $(obj).closest(".create");
                var relType = parseInt(this.getParam(createObj, "reltype"));
                var hour = this.getParam(createObj, "datehour");
                // console.log(hour)

                var dataForm = {
                    goodsname: $(createObj).find("textarea[name=goodsname]").val(),
                         type: (relType == 0 ? "markdown" : "promotional"),
                    begintime: this.getParam(createObj, "begintime"),
                    endtime: this.getParam(createObj, "endtime"),
                    remark: $(createObj).find("textarea[name=remark]").val(),
                    optype: t == 0 ? "store" : "release"
                };

                // dataForm["originalprice"] = parseFloat(this.getParam(createObj, "originalprice"));
                // dataForm["discountprice"] = parseFloat(this.getParam(createObj, "discountprice"));

                // console.log(dataForm["originalprice"]);
                // console.log(typeof dataForm["originalprice"]);
                dataForm["originalprice"] = this.getParam(createObj, "originalprice");
                //if($("input[name=originalprice]").val() == ""){
                //    dataForm["originalprice"] = 0;
                //    // console.log("originalprice: " + dataForm["originalprice"])
                //} else {

                //    // console.log("originalprice: " + dataForm["originalprice"]);
                //}
                dataForm["discountprice"] = this.getParam(createObj, "discountprice");
                //if($("input[name=discountprice]").val() == ""){
                //    dataForm["discountprice"] = 0;
                //    // console.log("discountprice: " + dataForm["discountprice"])
                //} else {

                //    // console.log("discountprice: " + dataForm["discountprice"]);
                //}
                var zhekou = dataForm["discount"] = (dataForm.discountprice / dataForm.originalprice * 10);
                dataForm["discount"] = zhekou.toString().substring(0, 3);
                //if($(".d-cont span").text() == ""){
                //    dataForm["discount"] = 0;
                //    // console.log("discount: " + dataForm["discount"])
                //}
                //else {
                //    // dataForm["discount"] = (dataForm.discountprice / dataForm.originalprice * 10)//.toFixed(1);
                //    // console.log(typeof zhekou);

                //}

                /*if($("input[name=unitprice]").val() == ""){
                    dataForm["unitprice"] = 0;
                    console.log("unitprice: " + dataForm["unitprice"])
                }

                if($("input[name=buycount]").val() == ""){
                    dataForm["buycount"] = 0;
                    console.log("buycount: " + dataForm["buycount"])
                }

                if($("input[name=giftcount]").val() == ""){
                    dataForm["giftcount"] = 0;
                    console.log("giftcount: " + dataForm["giftcount"])
                }*/


                // console.log(dataForm);
                // return;

                /*if (dataForm.discountprice <= dataForm.originalprice){
                    var zhekou = dataForm["discount"] = (dataForm.discountprice / dataForm.originalprice * 10);
                    dataForm["discount"] = zhekou.toString().substring(0, 3);
                }*/

                if ($.trim(dataForm.begintime).length == 0) {
                    toasterextend.showtips("请输入起始时间", "error");
                    return;
                }
                if ($.trim(dataForm.endtime).length == 0) {
                    toasterextend.showtips("请输入结束时间", "error");
                    return;
                }
                if (new Date(dataForm.endtime) < new Date(dataForm.begintime)) {
                    toasterextend.showtips("结束时间不能小于起始时间", "error");
                    return;
                }
                if ($.trim(hour).length == 0) {
                    toasterextend.showtips("请输入时", "error");
                    return;
                }

                // 发布
                if(t==1){

                    if ($.trim(dataForm.goodsname).length == 0) {
                        toasterextend.showtips("请输入商品名称", "error");
                        return;
                    }

                    /*if (dataForm.remark == "") {
                        toasterextend.showtips("请输入备注", "error");
                        return;
                    }*/

                    // 降价
                    if (relType == 0) {

                        // -------------------------------
                        // dataForm["originalprice"] = parseFloat(this.getParam(createObj, "originalprice"));
                        // dataForm["discountprice"] = parseFloat(this.getParam(createObj, "discountprice"));
                        dataForm["originalprice"] = this.getParam(createObj, "originalprice");
                        dataForm["discountprice"] = this.getParam(createObj, "discountprice");
                        // -------------------------------

                        //|| $.trim($("input[name=originalprice]").val()) == ""
                        if ($.trim(dataForm.originalprice).length == 0) {
                            toasterextend.showtips("请输入原价", "error");
                            return;
                        }

                        /*if (dataForm.discountprice <= dataForm.originalprice) {
                            var zhekou = dataForm["discount"] = (dataForm.discountprice / dataForm.originalprice * 10);//.toFixed(1);
                            dataForm["discount"] = zhekou.toString().substring(0, 3);
                        } */

                        if (dataForm.originalprice < 0 || parseInt(dataForm.originalprice).length > 7) {
                            toasterextend.showtips("原价格式不正确", "error");
                            return;
                        }
                        //|| $.trim($("input[name=discountprice]").val()) == ""
                        if ($.trim(dataForm.discountprice).length == 0) {
                            toasterextend.showtips("请输入优惠价", "error");
                            return;
                        }

                        if (dataForm.discountprice <= 0 || parseInt(dataForm.discountprice).length > 7) {
                            toasterextend.showtips("超惠价格式不正确", "error");
                            return;
                        }

                            // console.log($("input[name=discountprice]").val())
                            // console.log($("input[name=originalprice]").val())
                            // console.log(typeof dataForm.discountprice)
                            // console.log(dataForm.originalprice);
                            // return;
                        // if(parseInt($("input[name=discountprice]").val()) > parseInt($("input[name=originalprice]").val())) {
                        if (parseFloat(dataForm.discountprice) > parseFloat(dataForm.originalprice)) {
                            toasterextend.showtips("超惠价不能大于原价", "error");
                            return;
                        }
                        dataForm.endtime += " " + hour + ":00:00";

                    // 买赠
                    } else {

                        dataForm["unitprice"] = parseFloat(this.getParam(createObj, "unitprice"));
                        dataForm["buycount"] = parseInt(this.getParam(createObj, "buycount"));
                        dataForm["giftcount"] = parseInt(this.getParam(createObj, "giftcount"));
                        if ($.trim(dataForm.goodsname).length == 0) {
                            toasterextend.showtips("请输入商品名称", "error");
                            return;
                        }
                        if (this.getParam(createObj, "unitprice") == "" || this.getParam(createObj, "unitprice") == "0") {
                            toasterextend.showtips("请输入商品单价", "error");
                            return;
                        }
                        else {
                            dataForm["unitprice"] = this.getParam(createObj, "unitprice");
                        }
                        if (this.getParam(createObj, "buycount") == "" || this.getParam(createObj, "buycount") == "0") {
                            toasterextend.showtips("请输入买的数量", "error");
                            return;
                        }
                        else {
                            if (this.getParam(createObj, "buycount").indexOf(".") != -1 || this.getParam(createObj, "buycount").indexOf("-") != -1) {
                                isValid = false;
                                toasterextend.showtips("购买数量必须为整数", "error");
                                return;
                            } else {
                                dataForm["buycount"] = this.getParam(createObj, "buycount");
                            }
                        }
                        if (this.getParam(createObj, "giftcount") == "" || this.getParam(createObj, "giftcount") == "0") {
                            toasterextend.showtips("请输入赠的数量", "error");
                            return;
                        }
                        else
                        {
                            if (this.getParam(createObj, "giftcount").indexOf(".") != -1 || this.getParam(createObj, "giftcount").indexOf("-") != -1) {
                                isValid = false;
                                toasterextend.showtips("赠送数量必须为整数", "error");
                                return;
                            } else
                            {
                                isValid = true;
                                dataForm["giftcount"] = this.getParam(createObj, "giftcount");
                            }
                        }
                        dataForm.endtime += " " + hour + ":00:00";
                    }

                }

                // 保存
                else{

                    dataForm["originalprice"] = this.getParam(createObj, "originalprice");
                    dataForm["discountprice"] = this.getParam(createObj, "discountprice");
                    if (relType == 0) {
                        if ($.trim(dataForm.goodsname).length == 0) {
                            toasterextend.showtips("请输入商品名称", "error");
                            return;
                        }

                        if (dataForm["originalprice"] == "" || dataForm["originalprice"] == "0") {
                            isValid = false;
                            toasterextend.showtips("请输入原价", "error");
                            return;
                        }
                        if (dataForm["discountprice"] == ""||dataForm["discountprice"] == "0") {
                            isValid = false;
                            toasterextend.showtips("请输入优惠价", "error");
                            return;
                        }
                        dataForm.endtime += " " + hour + ":00:00";
                    }
                    else
                    {
                        dataForm["unitprice"] = parseFloat(this.getParam(createObj, "unitprice"));
                        dataForm["buycount"] = parseInt(this.getParam(createObj, "buycount"));
                        dataForm["giftcount"] = parseInt(this.getParam(createObj, "giftcount"));
                        if ($.trim(dataForm.goodsname).length == 0) {
                            toasterextend.showtips("请输入商品名称", "error");
                            return;
                        }
                        if (this.getParam(createObj, "unitprice") == "" || this.getParam(createObj, "unitprice") == "0") {
                            toasterextend.showtips("请输入商品单价", "error");
                            return;
                        }
                        else {
                            dataForm["unitprice"] = this.getParam(createObj, "unitprice");
                        }
                        if (this.getParam(createObj, "buycount") == "" || this.getParam(createObj, "buycount") == "0") {
                            toasterextend.showtips("请输入买的数量", "error");
                            return;
                        }
                        else {
                            if (this.getParam(createObj, "buycount").indexOf(".") != -1 || this.getParam(createObj, "buycount").indexOf("-") != -1) {
                                isValid = false;
                                toasterextend.showtips("购买数量必须为整数", "error");
                                return;
                            } else {
                                dataForm["buycount"] = this.getParam(createObj, "buycount");
                            }
                        }
                        if (this.getParam(createObj, "giftcount") == "" || this.getParam(createObj, "giftcount") == "0") {
                            toasterextend.showtips("请输入赠的数量", "error");
                            return;
                        }
                        else {
                            if (this.getParam(createObj, "giftcount").indexOf(".") != -1||this.getParam(createObj, "giftcount").indexOf("-") != -1) {
                                isValid = false;
                                toasterextend.showtips("赠送数量必须为整数", "error");
                                return;
                            } else {
                                isValid = true;
                                dataForm["giftcount"] = this.getParam(createObj, "giftcount");
                            }
                        }
                    }
                    dataForm.endtime += " " + hour + ":00:00";
                }

                dataForm["activityid"] = this.getParam(createObj, "activityid");
                console.log(dataForm);
                // return;
                this.saveData(createObj, t, dataForm);

            },

            // 编辑
            edit: function (obj) {
                $('#zt_xiugai').removeAttr("onclick");
                console.log(1);
                if ($(obj).closest(".relitem").next().is(".create")) {
                    $(obj).closest(".relitem").next().remove();
                    return;
                }

                _ajax("GET", '/webapi/retailer/owner/activities/' + $(obj).parent().attr("data-code"), null, function (json) {
                    // console.log(json);
                    // return;
                    var state = $(obj).parent().attr("data-state");
                    if (json.state == "上架") {
                        popup.show(4, null);
                        window.location.reload();
                    } else if (json.state == "未发布" && $.trim(json.reason).length > 0) {
                        convertformtoedit(obj, json);
                    }
                    else if (json.state == "未发布" && $.trim(json.reason).length == 0) {
                        convertformtoedit(obj, json);
                    }
                    else if (json.state == "审核失败" || json.state == "下架")
                    {
                        //if (json.state == state) {
                            convertformtoedit(obj, json);
                        //}
                        //else
                        //{
                        //    popup.show(5, null);
                        //    window.location.reload();
                        //}
                    }
                    else if (json.state == "审核中") {
                        popup.show(6, function () {
                            convertformtoedit(obj, json);
                        });
                        return;
                    }

                    // if(json.originalprice == "NaN"){
                    //     $("input[name=originalprice]").val("");//originalprice == "";
                    // }
                    // if(json.discountprice == "NaN"){
                    //     $("input[name=discountprice]").val("");//json.discountprice == "";
                    // }

                    // if(json.unitprice == "NaN"){
                    //     $("input[name=unitprice]").val("");
                    // }

                    // if(json.buycount == "NaN"){
                    //     $("input[name=buycount]").val("");
                    // }

                    // console.log("json.discount: " + json.discount);
                    if(json.discount == "NaN"){
                        $(".d-cont span").text("");
                    }

                });
            },

            saveData: function (createObj, t, dataForm) {
                // console.log($('.d-cont').text());
                // dataForm["discount"] = $('.d-cont span').text()

                var isUpdate = false;
                var url = "/webapi/retailer/activities";
                var method = "POST";
                if ($.trim(dataForm.activityid).length > 0 &&  $.trim(dataForm.activityid) != "0") {
                    isUpdate = true;
                    method = "PUT"
                    url = "/webapi/retailer/activities/" + dataForm.activityid;
                }
                    var rt = 8;
                    if (t == 0)
                        rt = 7
                    // else
                    if (dataForm.buycount) {
                        window.location.reload()
                    }
                // console.log(dataForm);
                    if (dataForm.length != length) {
                        length = dataForm.length;
                        _ajax(method, url, dataForm, function (json) {
                            popup.show(rt, function () {

                                if (isUpdate)
                                    createObj.prev().remove();
                                if (json.state == "未发布") {
                                    if ($("#list .no-release").length == 0)
                                        $("#list").append('<div class="container no-release"> <div class="a-title">未发布的活动</div>' + activity.getRelHtml(json) + '</div>');
                                    else {
                                        if (isUpdate && createObj.parent().is(".no-release"))
                                            createObj.before(activity.getRelHtml(json));
                                        else
                                            $("#list .no-release").append(activity.getRelHtml(json));
                                    }
                                }
                                else {
                                    if ($("#list .release").length == 0)
                                        $("#list").append('<div class="container release" style="padding-bottom:0"> <div class="a-title">已发布进行中的活动</div>' + activity.getRelHtml(json) + '</div>');
                                    else {
                                        if (isUpdate && createObj.parent().is(".release"))
                                            createObj.before(activity.getRelHtml(json));
                                        else
                                            $("#list .release").append(activity.getRelHtml(json));
                                    }
                l                }
                                createObj.remove();
                                // alert('shua')
                                window.location.reload();
                            });
                        });
                    } else {
                        window.location.reload();
                    }
            },

            getParam: function (obj, name) {
                /*var price = $(obj).find("input[name=" + name + "]").val();
                if(price == ""){
                    return 0;
                }
                return price;*/
                return $(obj).find("input[name=" + name + "]").val();
            },

            updateState: function (state, obj) {
                // console.log(state);
                // console.log(obj);
                var activityid = $(obj.parentNode).attr("data-code");
                // console.log(activityid);
                // return;


                var df = {};
                if(state == "up"){

                    var tr = $(obj).parent().prev().find('tr');
                    var relTypeText = tr.find('label.cut').text();

                    // return;
                    var beginTime = tr.find('.beginTime').text();
                    var etStr = tr.find('.endTime').text();
                    if(etStr.length < 10){
                        etStr = etStr + "00:00"
                    }

                    // console.log(etStr);//return

                    var type = "";
                    if(relTypeText == "买赠"){
                        type = "promotional";
                    } else {
                        type = "markdown";
                    }

                    var remark = tr.find('.bz').text();
                    var dataForm = {
                        begintime: $.trim(beginTime),
                        endtime: etStr,
                        remark: remark,
                        optype: "release",
                        type: type,
                    };

                    df = dataForm;

                    if(relTypeText == "买赠"){
                        df['type'] = "promotional";
                        df['unitprice'] = tr.find('.unitPrice').text();
                        df['buycount'] = tr.find('.buyCount').text();
                        df['giftcount'] = tr.find('.giftCount').text();
                        // console.log(df);
                        // return;

                    } else {
                        df['type'] = "markdown";
                        df['originalprice'] = tr.find('.originalPrice').text();
                        df['discountprice'] = tr.find('.discountPrice').text();
                        df['discount'] = tr.find('.disCount').text();
                        df['remark'] = tr.find('.bz').text();//return;

                        if(df.originalprice == ""){
                            toasterextend.showtips("原价不能为空，请先修改", "error");
                            return;
                        }

                        if(df.discountprice == ""){
                            toasterextend.showtips("优惠价不能为空，请先修改", "error");
                            return;
                        }

                        if(df.discount == ""){
                            toasterextend.showtips("折扣不能为空，请先修改", "error");
                            return;
                        }

                        // console.log(df);
                        // return;

                    }

                    if(df.begintime == ""){
                        toasterextend.showtips("活动起始时间不能为空，请先修改", "error");
                        return;
                    }

                    if(df.endtime == ""){
                        toasterextend.showtips("活动结束时间不能为空，请先修改", "error");
                        return;
                    }

                    /*if(df.remark == ""){
                        toasterextend.showtips("备注不能为空，请先修改", "error");
                        return;
                    }*/

                } else {
                    df = null;
                }


                // _ajax("PUT", '/webapi/retailer/activities/' + activityid + "/" + state, null, function (json) {
                _ajax("PUT", '/webapi/retailer/activities/' + activityid + "/" + state, df, function (json) {

                    // 发布
                    if (state == "up") {
                        var relObj = $(obj).parent().parent();
                        if (json.state == "审核中") {
                            relObj.find("table tr:eq(0) td").remove(".no-audit").append('<label class="auit">审核中</label>');
                            relObj.append('<ul class="op-pnl" data-code="' + activityid + '"><li style="width:50%;" onclick="activity.del(this)"><label class="op-del">删除</label></li><li style="width:50%;" onclick="activity.edit(this)"><label class="op-update" >修改</label></li><div class="clear"></div></ul>');
                        }
                        else if (json.state == "上架") {
                            relObj.find("table tr:eq(0) td").remove(".no-audit").append('<label class="released">已发布</label>');
                            relObj.find("table").append('<tr><td colspan="2" align="center" style="height:45px;"  data-code="' + activityid + '"><input type="button"   onclick="activity.stateDown(this)" value="下架" class="ots-btn"></td></tr>');
                            relObj.css("padding-bottom", "0");
                        }
                        $(obj).parent().remove();
                        $("#list .release").append(relObj[0].outerHTML);
                        activity.delRelItem(relObj);
                        popup.show(8, null);
                        window.location.reload();

                    // 下架
                    } else {
                        var relObj = $(obj).closest(".relitem");
                        console.log(relObj);
                        $(obj).parent().parent().remove();
                        relObj.find(".released").remove();
                        relObj.append('<ul class="op-pnl" data-code="' + activityid + '"><li  onclick="activity.del(this)"><label class="op-del">删除</label></li><li onclick="activity.edit(this)"><label class="op-update" >修改</label></li><li onclick="activity.updateState(\'up\',this)"><label class="op-release">发布</label></li></ul>');
                        relObj.css("padding-bottom", "50px");
                        $("#list .no-release").append(relObj[0].outerHTML);
                        activity.delRelItem(relObj);
                        popup.show(12, null);

                        // debugger;
                        // var wait = setTimeout(function(){
                            window.location.reload();
                        // },300)
                    }

                });
            },

            stateDown: function (obj) {
                popup.show(9, function () {
                    activity.updateState('down', obj);
                });
            }

        }

        var _ajax = function (type, url, data, success) {
            // console.log(data);//return;
            $.ajax({
                type: type,
                dataType: "json",
                url: url,
                data: data,
                beforeSend: function () { common.loading.show(); },
                complete: function () { common.loading.hide(); },
                timeout: function () { popup.show(2, null) },
                success: function (json) {
                    common.loading.hide();//隐藏转圈动画

                    json = json || {};   /* 统一加这句话 */
                    if (json.error) {
                        toasterextend.showtips(json.error, "error");
                        return;
                    }
                    if (json.user_notification != undefined) {
                        toasterextend.showtips(json.user_notification, "info");
                        return;
                    }

                    success(json);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    common.loading.hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                            errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    toasterextend.showtips(errormsg, "error");
                }
            });
        }

        var createHtml = '<div class="container create">'
            + '<div class="a-title">新创建活动</div>'
            + '<table cellpadding="0" cellspacing="0">'
            + '   <thead>'
            + '       <tr>'
            + '           <th width="75" height="40">活动类型</th>'
            + '           <td class="a-type">'
            + '               <a href="javascript:;" class="curr" onclick="cssObj.tabChange(0,this)">降价</a>'
            + '               <a href="javascript:;" onclick="cssObj.tabChange(1, this)">买赠</a>'
            + '               <input type="hidden" name="reltype" value="0" /><input type="hidden" name="activityid" value="" />'
            + '           </td>'
            + '        </tr>'
            + '     </thead>'
            + '    <tbody>'
            + '         <tr>'
            + '            <th valign="top">商品名称</th>'
            + '            <td>'
            + '                 <input type="hidden" name="retailerid" value="" />'
            + '                 <textarea class="g-name" id="zt_text" name="goodsname" maxlength="30" rows="3" placeholder="请输入商品名称"></textarea>'
            + '                 <label class="g-name-limit">0/30</label>'
            + '            </td>'
            + '        </tr>'
            + '        <tr data-type="0">'
            + '            <th style="line-height:40px;">原&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价<br />优&nbsp;&nbsp;惠&nbsp;&nbsp;价</th>'
            + '            <td class="price-box">'
            + '                <label class="money-ico">￥</label>'
            + '               <input type="text" min="0" maxlength="7" name="originalprice" style="padding-left:20px;" /><br />'
            + '               <label class="money-ico" style="top:62px;">￥</label>'
            + '               <input type="text" min="0" maxlength="7" name="discountprice" style="margin-top:10px;padding-left:20px;" />'
            + '               <div class="dis-box">'
            + '                   <div class="d-title">折扣</div>'
            + '                    <div class="d-cont"><span></span>折</div>'
            + '                </div>'
            + '           </td>'
            + '        </tr>'
            + '        <tr data-type="1" style="display:none">'
            + '            <th>单&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价</th>'
            + '            <td><label class="money-ico">￥</label><input name="unitprice" type="text" style="padding-left:20px;" /></td>'
            + '        </tr>'
            + '        <tr data-type="1" style="display:none">'
            + '            <th></th>'
            + '            <td><div style="display:inline-block;width:50%;position: relative;left: -22px;"><label style="margin: 0 2px 0 4px;">买</label><input type="text" name="buycount" style="width:80%" maxlength="7" /></div><div style="display:inline-block;width:50%;"><label style="margin: 0 2px 0 6%">赠</label><input name="giftcount" type="text" style="width:80%" maxlength="7"/></div></td>'
            + '        </tr>'
            + '        <tr>'
            + '             <th valign="top" style="line-height:40px;">活动时间</th>'
            + '             <td style="line-height:45px;">'
            + '                  <input type="text" name="begintime" class="date" />'
            + '                  <label style="padding:0 3px">至</label>'
            + '                  <input type="text" name="endtime" class="date" />'
            + '                  <input type="text" name="datehour" readonly="readonly" class="date-hour" />'
            + '              </td>'
            + '          </tr>'
            + '          <tr>'
            + '             <th valign="top">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注</th>'
            + '              <td>'
            + '                  <textarea placeholder="可输入活动特别要求，如限量限购等" class="g-name" name="remark" rows="5" maxlength="60"></textarea>'
            + '                  <label class="g-name-limit" style="top:100px;">0/60</label>'
            + '               </td>'
            + '           </tr>'
            + '           <tr>'
            + '               <td colspan="2" style="text-align:center;height:50px;">'
            + '                   <input type="button" class="save-btn" value="保存" onclick="activity.add(this,0);" />'
            + '                   <input type="button" class="rel-btn" value="发布" onclick="activity.add(this,1);" />'
            + '               </td>'
            + '            </tr>'
            + '        </tbody>'
            + '    </table>'
            + ' </div>';


    </script>
</body>
</html>
