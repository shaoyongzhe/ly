<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0" />
    <title>我的-店铺</title>

    <link rel="stylesheet" href="/retailer/css/weui.min.css" />
    <link rel="stylesheet" href="/retailer/css/retailerstyle.css" />
    <link href="/retailer/css/weixintips.css" rel="stylesheet" />
    <script src="/retailer/js/lib/common.js"></script>
    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/retailer\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>

    <script type="text/javascript" src="/js/jquery/toastr.min.js"></script>
    <script type="text/javascript" src="/js/wx/configinit.js"></script>

    
    <script src="/retailer/js/common-buttom-nav.js"></script>
    <style>
        .bd-bg {
            padding-left: 40px;
            box-sizing: border-box;
            background: url(../image/a.png) no-repeat left center;
            background-size: 40px;
        }

        .shop,
        .store,
        .addr {
            padding-left: 25px;
            box-sizing: border-box;
            overflow: hidden;
        }

        .shop {
            background: url(../image/g.png) no-repeat left center;
            background-size: 20px;
            text-overflow: ellipsis;
            height: 25px;
            line-height: 25px;
            white-space: nowrap;
        }

        .store {
            background: url(../image/s.png) no-repeat left center;
            background-size: 20px;
            text-overflow: ellipsis;
            height: 25px;
            line-height: 28px;
            white-space: nowrap;
            margin-top: 5px;
        }

        .addr {
            background: url(../image/addr.png) no-repeat left 3px;
            background-size: 20px;
            height: 45px;
            overflow: hidden;
            line-height: 22px;
            margin-top: 2px;
        }

        .s-box {
            border-radius: 3px;
            width: 94%;
            left: 3%;
            top: 200px;
            position: absolute;
            z-index: 101;
            box-sizing: border-box;
            overflow: inherit;
        }

            .s-box:last-child {
                border: 0;
            }

            .s-box .cont {
                background: #17a297;
                padding: 10px 30px;
                line-height: 25px;
                color: #fff;
            }

        .s-close {
            background: url(../image/close.png) no-repeat center center;
            width: 35px;
            height: 35px;
            background-size: 35px;
            position: absolute;
            right: -8px;
            top: -13px;
            z-index: 102;
        }

        .lazyout {
            width: 100%;
            height: 100%;
            background: #000;
            opacity: 0.5;
            z-index: 100;
            position: absolute;
        }
    </style>
    <script type="text/javascript">
        function getWin(obj, t) {
            var html = '<div id="win">'
              + '<div class="lazyout"></div>'
              + '<div class="weui_cells s-box" >'
              + '   <div class="s-close" onclick="closeWin();"></div>'
              + '    <div class="weui_cell">';
            if (t == 1)
                html += '<div class="weui_cell_bd weui_cell_primary"><img src="/retailer/image/we.jpg"  width="100%"/></div>';
            else
                html += '<div class="weui_cell_bd weui_cell_primary  bd-bg">' + $(obj).html() + '        </div>';
            html +=  '     </div>'
              + '    <div class="cont">请您核对签约门店是否是您的真实门店，如不正确，请您尽快解除。'
              + '     </div></div></div>';
            $("body").addClass("body");
            $("body").prepend(html);
            var h = $(window).height() > $(document.body).height() ? $(window).height() : $(document.body).height();
            $(".lazyout").height(h);
        }
        function closeWin() {
            $("#win").remove();
            $("body").css("overflow", "inherit")
        }
    </script>
</head>

<body>
    <div id="page" style="margin-bottom:80px">
    </div>
    <div id="bottom-nav"></div>

    <script type="text/javascript">

        var flag = true, n = 1;
        var y = 0; var W = '';
        var frametail = "</div>  </div> </div>";
        var page = "";


        var clickurl = "location.href= 'my_retailer_edit.html?retailer_id=retailer_guid'";
        var frame = [
                    '<div class="page">',
        '<div class="bd">',
            '<div class="weui_cells weui_height6em">',
                '<div class="weui_cell weui_bg_img" onclick="' + clickurl + '">',
                    '<div class="weui_photo150x150">',
                        '<img src="picture_url" alt="" />',
                    '</div>',
                    '<div class="weui_cell_bd weui_cell_primary">',
                        '<p class="Name16">retailername&nbsp;<img src="/retailer/image/edit.png" width="20" style="vertical-align:middle;"/></p>',
                        '<p class="Store14">address</p>',
                        '<p class="Store14">mobilephone</p>',
                    '</div>',
                    '<div class="weui_cell_ft">',
                        '<a href="invite_staff.html?retailer_id=retailer_guid" class="Derwei"><img src="/retailer/image/ewm_new.png" style="width:70px;height:auto;" alt="" /></a>',
                    '</div>',
                '</div>',
            '</div>',
        '</div>',
        '<div class="weui_state">',
            '<div class="weui_state_list">',
                '<strong> activeacount1<strong style="display:inline;font-size:14px">activeacount2</strong> </strong>',
                '<span>超惠活动</span>',
            '</div>',
            '<div class="weui_state_list">',
                '<strong> sharecount1<strong style="display:inline;font-size:14px">sharecount2</strong></strong>',
                '<span>分享</span>',
            '</div>',
            '<div class="weui_state_list">',
                '<strong> fanscount1<strong style="display:inline;font-size:14px">fanscount2</strong></strong>',
                '<span>累计拉粉</span>',
            '</div>',
            '<div class="weui_state_list">',
                '<strong>activefanscount1<strong style="display:inline;font-size:14px">activefanscount2</strong> </strong>',
                '<span>留存惠粉</span>',
            '</div>',
            '<div class="weui_state_list">',
                '<strong><strong style="display:inline;font-size:14px">fansremaincount</strong></strong>',
                '<span>留存</span>',
            '</div>',
        '</div>',
        '<div class="clear"></div>',
        '<div class="weui_cells weui_top3em">',
            '<div class="weui_cell">',
                '<div class="weui_cell_bd weui_cell_primary">',
                    '<p id="retailerdistributorcolunt"><strong>签约分销商（distributorcolunt）</strong><img src="/retailer/image/w.png" onclick="getWin(null,1)" width="25" style="float:right;marign-top:-3px;"/></p>',
                '</div>',
            '</div>',
        '</div>',
        '<div id="list">',
            '<div class="weui_cells" id="list1"></div>',
        '</div>'
        ].join("");


        $(function () {
            var notification = common.getUrlParam("notification");
            if (notification != "") {
                toasterextend.showtips(notification, "info");
            }
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '/webapi/retailer/weixin/getretailer',
                beforeSend: function () {common.loading.show(); },
                complete: function () {common.loading.hide(); },
                success: function (json) {
                   common.loading.hide();//隐藏转圈动画

                    json = json || {};   /* 统一加这句话 */
                    if (json.error) {
                        toasterextend.showtips(json.error, "error");
                        return;
                    }
                    if (json.user_notification != undefined) {
                        toasterextend.showtips(json.user_notification, "info");
                        return;
                    }

                    $.each(json.data, function (i, value) {
                        page += frame;
                        var retailer = value.retailer;
                        var re = new RegExp("retailer_guid", "g");
                        page = page.replace(re, retailer.guid);

                        if (retailer.picture_url != null)
                            page = page.replace("picture_url", retailer.picture_url);
                        if (typeof (retailer.retailername) !== 'undefined')
                            page = page.replace("retailername", retailer.retailername == null ? "" : retailer.retailername);
                        if (typeof (retailer.address) !== 'undefined')
                            page = page.replace("address", retailer.address == null ? "" : retailer.address);
                        if (typeof (retailer.mobilephone) !== 'undefined')
                            page = page.replace("mobilephone", retailer.mobilephone == null ? "" : retailer.mobilephone);

                        var contribute = value.contribute;
                        if (typeof (contribute.activtycount) !== 'undefined') {
                            change(contribute.activtycount);
                            page = page.replace("activeacount1", y);
                            page = page.replace("activeacount2", W);
                        }
                        if (typeof (contribute.sharecount) !== 'undefined') {
                            change(contribute.sharecount);
                            page = page.replace("sharecount1", y);
                            page = page.replace("sharecount2", W);
                        }

                        if (typeof (contribute.fansinhistorycount) !== 'undefined') {
                            change(contribute.fansinhistorycount);
                            page = page.replace("fanscount1", contribute.fansinhistorycount);
                            page = page.replace("fanscount2", W);
                        }

                        if (typeof (contribute.activefanscount) != 'undefined') {
                            change(contribute.activefanscount);
                            page = page.replace("activefanscount1", y);
                            page = page.replace("activefanscount2", W);
                        }
                            
                            

                        if (typeof (contribute.percentageretained) !== 'undefined')
                            page = page.replace("fansremaincount", contribute.percentageretained);

                        var distributors = value.distributor;
                        var count = 0;
                        var retailerguid222 = "";
                        $.each(distributors, function (i, distributorsvalue) {
                            count++;
                            page += "<div id=\"" + distributorsvalue.guid + distributorsvalue.retailerguid + "\" class=\"weui_cells\" ><div class=\"weui_cell\"> <div class=\"weui_cell_bd weui_cell_primary  bd-bg\"  onclick=\"getWin(this,0)\"><p class=\"shop\">";
                            if (typeof (distributorsvalue.name) !== 'undefined')
                                page += distributorsvalue.name;
                            page += "</p><p class=\"Store14 addr\">" + distributorsvalue.address + "</p><p class=\"store\">" + distributorsvalue.retailername + "</p></div><div class=\"weui_cell_ft\"><a href=\"javascript:firm('" + distributorsvalue.guid + "&" + distributorsvalue.domain + "&" + distributorsvalue.retailerguid + "');\" class=\"weui_btn weui_btn_exit\">解除</a></div></div></div>";
                            retailerguid222 = distributorsvalue.retailerguid;
                        });

                        page = page.replace("retailerdistributorcolunt", retailerguid222 + "cnt");
                        page = page.replace("distributorcolunt", count);
                        page += frametail;
                    });

                    $("#page").html(page);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                   common.loading.hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                            errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    toasterextend.showtips(errormsg, "error");
                }
            });
        });

        function change(x) {
            if (x < 10000) {
                y = x;
                W = '';
            }
            if (x > 9999 && x < 100000000) {
                y = x / 10000;
                W = '万';
            }
            if (x > 99999999) {
                y = x / 100000000;
                W = '亿';
            }
        }

        function firm(id) {
            //利用对话框返回的值 （true 或者 false）
            if (confirm("您确定要解除绑定吗？")) {
                var canshu = id.split('&');
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    beforeSend: function () {common.loading.show() },
                    complete: function () {common.loading.hide(); },
                    url: '/webapi/retailer/weixin/cancelsigndistributor?distributor_id=' + canshu[0] + '&distributor_domain=' + canshu[1] + '&retailer_id=' + canshu[2],
                    success: function (json) {

                       common.loading.hide();//隐藏转圈动画

                        if (json.error) {
                            toasterextend.showtips("解除失败", "info");

                        }
                        else {
                            toasterextend.showtips("解除成功", "info");
                            $("#" + canshu[0] + canshu[2]).remove();
                            var emcount = $("#" + canshu[2] + "cnt").text();
                            var kuohaoqian = emcount.split("（");
                            var kuohaohou = kuohaoqian[1].split("）");
                            var count = parseInt(kuohaohou[0]) - 1;
                            $("#" + canshu[2] + "cnt").text(kuohaoqian[0] + "（" + count + "）");
                        }
                    }
                });
            }
        }

        //弹出垂直菜单
        $(".menu").click(function () {
            if ($(this).hasClass("cura")) {
                $(this).children(".new-sub").hide(); //当前菜单下的二级菜单隐藏
                $(".menu").removeClass("cura"); //同一级的菜单项
            } else {
                $(".menu").removeClass("cura"); //移除所有的样式
                $(this).addClass("cura"); //给当前菜单添加特定样式
                $(".menu").children(".new-sub").slideUp("fast"); //隐藏所有的二级菜单
                $(this).children(".new-sub").slideDown("fast"); //展示当前的二级菜单
            }
        });
    </script>
</body>
</html>
