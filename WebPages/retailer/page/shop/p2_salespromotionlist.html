<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="wispanh=device-wispanh, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>分销商首页-某一品项（加载中）</title>
		<link href="../../css/master.css" rel="stylesheet" type="text/css">
		<link href="../../css/menu.css" rel="stylesheet" type="text/css">
		<link href="../../css/layout.css" rel="stylesheet" type="text/css">
		<link href="../../css/style3.css" rel="stylesheet" type="text/css">
		<link href="../../css/common.css" rel="stylesheet" type="text/css">
		<script type="text/javascript" src="../../js/jquery-1.7.2.min.js"></script>
		<script type="text/javascript" src="../../js/frameLayout.js"></script>
		<script src="../../js/retailerid.js"></script>
		<script type="text/javascript">
			var search = window.location.search;
			var distributor_id = search.substring(search.indexOf("=") + 1);
			var itemArray = [];
			var supplierids = {};
			$(document).ready(function() {

				//搜索关键词
				$('.content').on('keyup', function() {
					$('.clear').show();
				});
				$('.clear').click(function() {
					$('.content').val('');
				});
				// 分销商悬浮信息
				$(window).scroll(function() {
					var scrolltop = $(window).scrollTop();
					console.log(scrolltop)
					if(scrolltop > 50) {
						$(".dealer-header").fadeIn();
					} else {
						$(".dealer-header").fadeOut();
					}
				});

				//作用：计算购物车中的数量，购物车总价格
				$.get("/webapi/account/login/test-2-135-1", {}, function() {}, false);
				var shopcart;
				$.ajax({
					url: "/webapi/distributor/" + getRetailerid() + "/shoppingcart/" + distributor_id + "?isvalid=0",
					async: true,
					cache: false,
					dataType: "json",
					timeout : 1000,
					success: function(data) {
						var Totalprice = 0; //计算购物车中的价格
						var Itemcount_ = 0; //购物车中商品的数量
						var shoppingcart;
						for(var i = 0; i < data.length; i++) {
							shoppingcart = data[i];
							var id = shoppingcart.activityitem_id;
							if(id.length > 0) //【1】：有活动时 
							{
								if(shoppingcart.salestop == 1) //[1,0]下架商品  
								{
									// alert("有活动下架")
									if(shoppingcart.itemkind == '折扣') {
										Totalprice += Number(shoppingcart.discountprice * shoppingcart.itemcount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '买赠') {
										Totalprice += Number(shoppingcart.unitprice * shoppingcart.itemcount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '有礼') {
										Totalprice += Number(shoppingcart.saleprice * shoppingcart.salecount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '降价') {
										Totalprice += Number(shoppingcart.discountprice * shoppingcart.itemcount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}

								} else //[1.1] 上架商品
								{
									// alert("有活动上架")
									if(shoppingcart.itemkind == '折扣') {
										Totalprice += Number(shoppingcart.discountprice * shoppingcart.itemcount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '买赠') {
										Totalprice += Number(shoppingcart.unitprice * shoppingcart.salecount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '有礼') {
										Totalprice += Number(shoppingcart.saleprice * shoppingcart.salecount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}
									if(shoppingcart.itemkind == '降价') {
										Totalprice += Number(shoppingcart.discountprice * shoppingcart.itemcount);
										Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
									}

								}
							} //【1】：有活动时结束

							if(id.length == 0) //【2】：无活动  
							{
								if(shoppingcart.salestop == 1) //[2.0] 下架商品      
								{
									//alert("无活动下架")
									Totalprice += Number(shoppingcart.price * shoppingcart.salecount);
									Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
								} else //[2.0] 上架商品
								{
									//alert("无活动 上架 ")
									var index = shoppingcart.selectedindex; //索引  selectedindex
									for(var j = 0; j < shoppingcart.itemslist.length; j++) {
										if(j == index) {
											Totalprice += Number(shoppingcart.price * shoppingcart.salecount);
											Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
										}
									}

								}

							} //【2】：无活动 结束

							if(shoppingcart.isyucun == 1) //【3】是预存货
							{
								if(shoppingcart.salestop == 1) //[3.0] :下架    
								{
									Totalprice += Number(shoppingcart.price * shoppingcart.salecount);
									Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
								} else //[3.1] :上架
								{
									Totalprice += Number(shoppingcart.itemunitcost * shoppingcart.refundtotal);
									Itemcount_ += Number(Itemcount_) + Number(shoppingcart.itemcount);
								}
							} //【3】是预存货 结束

						} //for循环结束  计算价格和数量结束

						var strtemp = '￥' + Totalprice + '元';
						$(".price").html(strtemp);
						$(".num").html(Itemcount_);
						$(".ammount").html(Itemcount_);

					},
					complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
						if(status == 'timeout') { //超时,status还有success,error等值的情况
							//ajaxTimeout.abort();
							alert("请求超时");
						} else if(status == 'error') {
							//alert("网络错误");
						}
					}

				}); //请求的购物车API结束

				//标记购物车中是否有商品
				$.ajax({
					url: "/webapi/distributor/" + getRetailerid() + "/shoppingcart/" + distributor_id + "?isvalid=0",
					async: true,
					cache: false,
					dataType: "json",
					timeout : 1000,
					success: function(data) {
						shopcart = data;
						if(data.length != 0) {
							$("#shopcartammount_img").attr("src", "../../image/shop/buycar.png")
						} else {
							$("#shopcartammount_img").attr("src", "../../image/shop/shopcart.png")
						}
					},
					complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
						if(status == 'timeout') { //超时,status还有success,error等值的情况
							//ajaxTimeout.abort();
							alert("请求超时");
						} else if(status == 'error') {
							//alert("网络错误");
						}
					}
				});

				//点击购物车
				$(".footerl").click(function() {
					var search = window.location.search;
					var distributor_id = search.substring(search.indexOf("=") + 1);
					if(shopcart.length != 0) {
						window.location.href = "p7_shopcart.html?distributor_id=" + distributor_id;
						return false;
					}

				});
				//点击购物车结束

				//显示分销商的信息
				$.ajax({
					url: "/webapi/distributor/" + getRetailerid() + "/distributors",
					async: true,
					cache: false,
					dataType: "json",
					timeout : 1000,
					success: function(data) {
						for(var i = 0; i < data.length; i++) {
							if(data[i].distributor_id == distributor_id) {
								$("#distributorname").text(data[i].distributorname);
								$("#distributorimg").attr("src", data[i].distributorimg);
								$("#distributornameh3").text(data[i].distributorname);
								$("#contactperson").text(data[i].contactperson);
								$("#cutgift").text(data[i].cutgift);
							}
							break;
						}
					},
					complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
						if(status == 'timeout') { //超时,status还有success,error等值的情况
							//ajaxTimeout.abort();
							alert("请求超时");
						} else if(status == 'error') {
							//alert("网络错误");
						}
					}
				});
				//显示分销商的信息 结束

				//提交
				$(".footerr").click(function() {
					var search = window.location.search;
					var distributor_id = search.substring(search.indexOf("=") + 1);
					var str = '[';
					//$.get("http://membership-waibao.ipaloma.com/webapi/account/login/test-2-135-1",{},function(){},false);
					$.ajax({
						//url:"http://membership-waibao.ipaloma.com/webapi/distributor/c45e3940739345cab03730d445ec7e74/shoppingcart/"+distributor_id+"?isvalid=0",
						url: "webapi/distributor/" + getRetailerid() + "/shoppingcart/" + distributor_id + "?isvalid=0",
						async: false, //必须的设置成同步  必须的ajax执行完成后 才能跳转
						cache: false,
						dataType: "json",
						timeout : 1000,
						success: function(data) {
							//添加商品 
							var shoppingcart;
							for(var i = 0; i < data.length; i++) {
								shoppingcart = data[i];
								//没有下架的商品
								if(shoppingcart.hasOwnProperty("salestop") == false || shoppingcart.salestop == 0) {
									str += '{"itemid":"' + shoppingcart.itemid + '","isyucun":"' + shoppingcart.isyucun + '","activityitem_id":"' + shoppingcart.activityitem_id + '"},';
								}

							} //for循环结束

						},
						complete: function(XMLHttpRequest, status) { //请求完成后最终执行参数
							if(status == 'timeout') { //超时,status还有success,error等值的情况
								//ajaxTimeout.abort();
								alert("请求超时");
							} else if(status == 'error') {
								//alert("网络错误");
							}
						}
					}); //ajax结束
					str = str.substring(0, str.length - 1);
					str += ']';
					urlinfo = "p12_orderconfirm.html?a=" + str + "=distributor_id=" + distributor_id;
					encodeURI(urlinfo);
					window.location.href = urlinfo;
				});
				//提交结束

			})
		
		</script>
	</head>

	<body oncontextmenu="return false">
		<div class="container">
			<!-- dealer-header start-->
			<div class="dealer-header">
				<i>青龙御园聚鲜珍品海鲜聚鲜珍</i><em><a href="tel:18337166803"><img src="../../image/shop/icon_tel.png" alt=""></a></em>
			</div>
			<!-- dealer-header end-->
			<!--proTitleBox start-->
			<div class="proTitleBox">
				<div class="proTitleBoxl"><img src="../../image/shop/titleImg1.png" width="112" height="112" id="distributorimg"></div>
				<div class="proTitleBoxr">
					<h3 id="distributornameh3">青龙御园聚鲜珍品海鲜</h3>
					<div class="proTitleInfo">
						<div class="proTitleInfol">
							<span>联系人</span><span id="contactperson">梁开选</span><br/>
							<span>起送价</span><span id="cutgift">￥150元</span><br/>
						</div>
						<div class="proTitleInfor">
							<a href="tel:18337166803">
								<img src="../../image/shop/telBtn.png" width="58" height="58" alt="" />
							</a>
						</div>
					</div>
				</div>
			</div>

			<!--proTitleBox end-->
			<!--proDetailBox start-->
			<div class="proDetailBox">
				<div class="proDetailBoxl">
					<!-- info1 start-->
					<div class="info1 ">
						<div class="rp">微信下单立减5元</div>
					</div>
					<!-- info1 end-->
					<!-- info2 start-->
					<div class="info1 info2">
						<div class="rp">满400减40元；满200减20元；满100减10元</div>
					</div>
					<!-- info2 end-->
				</div>

				<div class="proDetailBoxr"><img src="../../image/shop/arrow_down.png" width="28" height="20"></div>

			</div>
			<!--proDetailBox end-->
			<!--search start-->
			<div class="proSearch">
				<div class="titlestyle">品牌</div>
				<div class="inputbox"><input type="text" class="content" placeholder="伊利" /></div>
				<i class="clear"></i>
				<div class="searchbtn"><img src="../../image/shop/icon_zoom.png" width="33" height="33"></div>
			</div>
			<!--search end-->
			<!-- frame start-->
			<div id="frameMiddel">
				<div id="frameMiddelLeft">
					<iframe src="frame/left_nav.html" scrolling="no" frameborder="0" name="left"></iframe>
				</div>

				<div id="frameMiddelRight">
					<iframe src="mygoodslist.html" frameborder="0" name="right"></iframe>
				</div>
			</div>
			<!-- frame end-->

		</div>

		<!-- footer start -->
		<footer>
			<div class="footerl">
				<div class="cart"><span class="ammount">0</span></div>
				<div class="price">￥0元</div>
			</div>
			<div class="footerr"><input type="button" class="">去提交(<span class="num">0</span>)</div>
		</footer>
		<!-- footer end -->

	</body>

</html>