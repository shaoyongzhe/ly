<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0" />
    <title>店铺信息</title>

    <link rel="stylesheet" href="/retailer/css/weui.min.css" />
    <link rel="stylesheet" href="/retailer/css/retailerstyle.css" />
    <link rel="stylesheet" href="/retailer/css/weixintips.css" />
    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/retailer\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script src="/js/jquery/1.11.3/jquery.js"></script>
    <script src="/retailer/js/common-buttom-nav-debug.js"></script>
    <script src="/js/jquery/toastr.min.js"></script>
    <script type="text/javascript" src="/retailer/js/lib/jquery-toastr-extend.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/wx/weixinconfiginit-debug.js"></script>
    <style>
        .pin-spinner {
            display: none;
            width: 34px;
            height: 34px;
            position: fixed;
            margin-left: -17px;
            z-index: 999999999;
            left: 50%;
            top: 35%;
        }

        .pin-spinner-container1 > div, .pin-spinner-container2 > div, .pin-spinner-container3 > div {
            width: 10px;
            height: 10px;
            background-color: #457486;
            border-radius: 100%;
            position: absolute;
            -webkit-animation: bouncedelay 1.2s infinite ease-in-out;
            animation: bouncedelay 1.2s infinite ease-in-out;
            -webkit-animation-fill-mode: both;
            animation-fill-mode: both;
        }

        .pin-spinner .pin-spinner-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .pin-spinner-container2 {
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }

        .pin-spinner-container3 {
            -webkit-transform: rotate(90deg);
            -ms-transform: rotate(90deg);
            transform: rotate(90deg);
        }

        .pin-spinner-circle1 {
            top: 0;
            left: 0;
        }

        .pin-spinner-circle2 {
            top: 0;
            right: 0;
        }

        .pin-spinner-circle3 {
            right: 0;
            bottom: 0;
        }

        .pin-spinner-circle4 {
            left: 0;
            bottom: 0;
        }

        .pin-spinner-container2 .pin-spinner-circle1 {
            -webkit-animation-delay: -1.1s;
            animation-delay: -1.1s;
        }

        .pin-spinner-container3 .pin-spinner-circle1 {
            -webkit-animation-delay: -1s;
            animation-delay: -1s;
        }

        .pin-spinner-container1 .pin-spinner-circle2 {
            -webkit-animation-delay: -.9s;
            animation-delay: -.9s;
        }

        .pin-spinner-container2 .pin-spinner-circle2 {
            -webkit-animation-delay: -.8s;
            animation-delay: -.8s;
        }

        .pin-spinner-container3 .pin-spinner-circle2 {
            -webkit-animation-delay: -.7s;
            animation-delay: -.7s;
        }

        .pin-spinner-container1 .pin-spinner-circle3 {
            -webkit-animation-delay: -.6s;
            animation-delay: -.6s;
        }

        .pin-spinner-container2 .pin-spinner-circle3 {
            -webkit-animation-delay: -.5s;
            animation-delay: -.5s;
        }

        .pin-spinner-container3 .pin-spinner-circle3 {
            -webkit-animation-delay: -.4s;
            animation-delay: -.4s;
        }

        .pin-spinner-container1 .pin-spinner-circle4 {
            -webkit-animation-delay: -.3s;
            animation-delay: -.3s;
        }

        .pin-spinner-container2 .pin-spinner-circle4 {
            -webkit-animation-delay: -.2s;
            animation-delay: -.2s;
        }

        .pin-spinner-container3 .pin-spinner-circle4 {
            -webkit-animation-delay: -.1s;
            animation-delay: -.1s;
        }

        @-webkit-keyframes bouncedelay {
            0%,80%,to {
                -webkit-transform: scale(0);
                transform: scale(0);
            }

            40% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }

        @keyframes bouncedelay {
            0%,80%,to {
                -webkit-transform: scale(0);
                transform: scale(0);
            }

            40% {
                -webkit-transform: scale(1);
                transform: scale(1);
            }
        }
    </style>
    <style>
        .curr-addr {
            background: #f1efef;
            box-sizing: border-box;
            padding: 5px 12px;
            min-height: 30px;
            line-height: 22px;
            overflow: hidden;
            width: 100%;
            color: #b3b2b2;
            font-size: 15px;
            /*border-bottom: 1px solid #d9d9d9;*/
        }

        .btn {
            font-size: 14px;
            background: #2bc9be;
            color: #fff;
            border: 0;
            padding: 5px;
            border-radius: 3px;
            float: right;
            -webkit-appearance: none;
        }
    </style>

</head>

<body>
    <div class="pin-spinner" style="display:block;">
        <div class="pin-spinner-container pin-spinner-container1">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container2">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container3">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
    </div>
    <div class="page">
        <div class="bd">
            <div class="weui_cells weui_height6em">
                <div class="weui_cell weui_bg_img">
                    <div class="weui_photo150x150"><img id="retailerimg" src="" alt="" /></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <p id="retailername" class="Name16"></p>
                        <p id="retaileradres" class="Store14"></p>
                        <p id="retailertel" class="Store14"></p>
                    </div>
                    <div class="weui_cell_ft"><a id="idInviteRetailerEmployee" href="invite_staff.html" class="Derwei"><img src="/retailer/image/ewm_new.png" style="width:70px;height:auto;" alt="" /></a></div>
                </div>
            </div>
            <div class="clear"></div>

            <!--图片上传-->
            <!--<div class="weui_cells weui_cells_form weui_top3em">
                <div class="weui_cell">
                    <div class="weui_cell_bd weui_cell_primary">
                        <div class="weui_uploader">
                            <div class="weui_uploader_bd">
                                <div class="weui_uploader_title_left">店铺图片</div>
                                <div class="weui_uploader_input_wrp">
                                    <input id="fileUpload" class="weui_uploader_input" type="file" accept="image/jpg,image/jpeg,image/png,image/gif" multiple=multiple />
                                </div>
                                <ul class="weui_uploader_files">
                                    <li class="weui_uploader_file" style="background-image:url(../image/)"></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>-->
            <!--信息修改或提交-->
            <div class="weui_cells weui_cells_form">
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">店铺：</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input id="updatename" name="retailername" class="weui_input" type="text" placeholder="请输入店铺名称" />
                    </div>
                </div>

                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">地址：</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input id="updatedadress" name="address" class="weui_input" style="width:98%;" type="text" placeholder="请输入详细地址" />
                    </div>

                </div>
                <div class="curr-addr" id="curr-addr">
                    <div>
                        当前位置：<label></label>
                    </div>
                    <div>
                        <input type="button" class="btn" id="useCurrentAddr" value="使用当前位置" onclick="getAddr()" />
                        <script>
                            function getAddr() {
                                $("#updatedadress").val($("#curr-addr label").text());
                                useflag = true;
                            }
                        </script>
                    </div>
                </div>
                <div class="weui_cell">
                    <div class="weui_cell_hd"><label class="weui_label">电话：</label></div>
                    <div class="weui_cell_bd weui_cell_primary">
                        <input id="updatetel" name="mobilephone" class="weui_input" type="number" pattern="[0-9]*" placeholder="请输入电话号码" />
                        <input type="hidden" id="retailerid" name="retailerid" type="text" />
                    </div>
                </div>
            </div>

            <div class="weui_btn_area">
                <input type="submit" value="确 定" id="btnUploadFile" class="weui_btn weui_btn_exit" style="height:36px;line-height:25px; padding-top:4px;font-size:16px" /></br>
            </div>
        </div>

        <div class="weui_Kong"></div>

    </div>
    <div id="bottom-nav"></div>   

    <script type="text/javascript">

        var antiaddress, districthash, province, city, district, xlatitude, xlongitude, useflag = false;

        function getLoaction(longitude, latitude) {

            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: "/webapi/retailer/weixin/antiaddress?longitude=" + longitude + "&latitude=" + latitude,
                beforeSend: function () { $(".pin-spinner").show(); },
                complete: function () { $(".pin-spinner").hide(); },
                success: function (json) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    json = json || {};   /* 统一加这句话 */
                    if (json.error) {
                        toasterextend.showtips(json.error, "error");
                        return;
                    }
                    if (json.user_notification != undefined) {
                        toasterextend.showtips(json.user_notification, "info");
                        return;
                    }

                    antiaddress = json.antiaddress;
                    districthash = json.districthash;
                    province = json.province;
                    city = json.city;
                    district = json.district;

                    $("#curr-addr label").text(antiaddress);


                    $("#curr-addr").show();
                    $("#useCurrentAddr").show();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                        errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    toasterextend.showtips(errormsg, "error");
                }
            });
        }

        $(function () {

            $("#curr-addr").hide();
            $("#useCurrentAddr").hide();
            if (typeof (wxjsconfig.apimode) != 'undefined'
                && (wxjsconfig.apimode == "test" || wxjsconfig.apimode == "demo")
                && typeof (wxjsconfig.testdata) != 'undefined' && typeof (wxjsconfig.testdata.location) != 'undefined'
                && typeof (wxjsconfig.testdata.location.latitude) != 'undefined'
                && typeof (wxjsconfig.testdata.location.longitude) != 'undefined')
                getLoaction(wxjsconfig.testdata.location.longitude, wxjsconfig.testdata.location.latitude);
            else
                wx.ready(function () {
                    toasterextend.showtips("正在获取位置", "info");
                    wx.getLocation({
                        type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                        success: function (res) {
                            toasterextend.hidetips();
                            xlatitude = null; xlongitude = null;
                            xlatitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                            xlongitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。


                            getLoaction(xlongitude, xlatitude);
                        },
                        fail: function () {
                            //屏蔽使用当前位置样式
                            toasterextend.hidetips();
                            $("#curr-addr").hide();
                            $("#useCurrentAddr").hide();
                        }
                    });
                });


            var retailerid = "";
            var urlinfo = window.location.href; //获取当前页面的url
            var len = urlinfo.length;//获取url的长度
            var offset = urlinfo.indexOf("?");//设置参数字符串开始的位置
            if (offset != -1) {
                var newsidinfo = urlinfo.substr(offset, len)//取出参数字符串 这里会获得类似“id=1”这样的字符串
                var newsids = newsidinfo.split("=");//对获得的参数字符串按照“=”进行分割
                retailerid = newsids[1];//得到参数值
            }

            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '/webapi/retailer/weixin/getonlyoneretailer?retailer_id=' + retailerid,
                beforeSend: function () { $(".pin-spinner").show(); },
                complete: function () { $(".pin-spinner").hide(); },
                success: function (json) {
                    $(".pin-spinner").hide();
                    json = json || {};   /* 统一加这句话 */
                    if (json.error) {
                        toasterextend.showtips(json.error, "error");
                        return;
                    }
                    if (json.user_notification != undefined) {
                        toasterextend.showtips(json.user_notification, "info");
                        return;
                    }
                    $("#idInviteRetailerEmployee").attr("href", "invite_staff.html?retailer_id=" + retailerid);
                    var retailer = json.retailer;

                    if (retailer.picture_url != null) {
                        $("#retailerimg").attr("src", retailer.picture_url);
                    }

                    if (typeof (retailer.retailername) !== 'undefined') {
                        $("#retailername").html(retailer.retailername);
                        $("#updatename").val(retailer.retailername);
                    }

                    if (typeof (retailer.address) !== 'undefined') {
                        $("#retaileradres").html(retailer.address);
                        $("#updatedadress").val(retailer.address);
                    }

                    if (typeof (retailer.mobilephone) !== 'undefined') {
                        $("#retailertel").html(retailer.mobilephone);
                        $("#updatetel").val(retailer.mobilephone);
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                        errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    toasterextend.showtips(errormsg, "error");
                }
            });


            $('#btnUploadFile').on('click', function () {
                var updatename = $("#updatename").val();
                var updatedadress = $("#updatedadress").val();
                var updatetel = $("#updatetel").val();

                if (updatename.trim() == '') {
                    toasterextend.showtips('店铺名称不能为空', "info");
                    return false;
                }
                if (updatedadress.trim() == '') {
                    toasterextend.showtips('店铺地址不能为空', "info");
                    return false;
                }

                var updatedata = { "retailername": updatename, "address": updatedadress, "mobilephone": updatetel, "guid": retailerid };

                if (xlatitude != undefined && xlatitude != null && xlongitude != undefined && xlongitude != null && useflag) {
                    updatedata = {
                        "retailername": updatename,
                        "address": updatedadress,
                        "mobilephone": updatetel,
                        "guid": retailerid,
                        "antiaddress": antiaddress,
                        "districthash": districthash,
                        "province": province,
                        "city": city,
                        "district": district,
                        "longitude": xlongitude,
                        "latitude": xlatitude
                    };
                    useflag = false;
                }



                $.ajax({
                    type: 'post',
                    url: "/webapi/retailer/weixin/updateretailer",
                    dataType: 'json',
                    data: updatedata,
                    complete: function () { useflag = false; },
                    success: function (data) {
                        $(".pin-spinner").hide();//隐藏转圈动画

                        data = data || {};   /* 统一加这句话 */
                        toasterextend.showtips("修改成功！", "info");
                        setTimeout(function () { window.location.reload(); }, 2000);

                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $(".pin-spinner").hide();//隐藏转圈动画

                        var errormsg = "访问异常";

                        if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                            var json = JSON.parse(XMLHttpRequest.responseText);
                            errormsg = JSON.parse(json.Message).error;
                            if (errormsg == undefined || errormsg == '')
                            errormsg = "Http error: " + XMLHttpRequest.statusText;
                        }

                        toasterextend.showtips(errormsg, "error");
                    }
                });
            });
        });

        //弹出垂直菜单
        $(".menu").click(function () {
            if ($(this).hasClass("cura")) {
                $(this).children(".new-sub").hide();    //当前菜单下的二级菜单隐藏
                $(".menu").removeClass("cura");         //同一级的菜单项
            } else {
                $(".menu").removeClass("cura");         //移除所有的样式
                $(this).addClass("cura");               //给当前菜单添加特定样式
                $(".menu").children(".new-sub").slideUp("fast"); //隐藏所有的二级菜单
                $(this).children(".new-sub").slideDown("fast"); //展示当前的二级菜单
            }
        });

    </script>
</body>
</html>
