<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 ,minimum-scale =1, maximum-scale =1, user-scalable = no" />
    <meta name="format-detection" content="telephone=no" />
    <title>手机号绑定</title>

    <link href="/distributor/css/bootstrap.css" rel="stylesheet" />
    <link href="/distributor/css/font-awesome.css" rel="stylesheet" />
    <link href="/distributor/css/jquery-ui.css" rel="stylesheet" />
    <link href="/distributor/css/ace.css" rel="stylesheet" />
    <link type="text/css" href="/distributor/css/style.css" rel="stylesheet" />
    <link href="/distributor/css/weixin.css" rel="stylesheet" />
    <link href="/distributor/css/weixintips.css" rel="stylesheet" />

    <script type="text/javascript" src="/js/jquery/1.11.3/jquery.js"></script>
    <script src="/distributor/js/lib/lib.js" type="text/javascript"></script>
    <script src="/js/jquery/toastr.min.js"></script>
    <script type="text/javascript" src="/distributor/js/lib/jquery-toastr-extend.js"></script>
    <script type="text/javascript" src="/distributor/js/lib/jquery-common-debug.js"></script>
    <script type="text/javascript" src="/distributor/js/lib/common-debug.js"></script>
    <script type="text/javascript" src="/distributor/js/jquery-ui.js"></script>
    <script type="text/javascript" src="/distributor/js/jquery.unobtrusive-ajax.min.js"></script>
    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/distributor\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/wx/weixinconfiginit-debug.js"></script>	   

    <style>
        .rowStyle {
            /*margin-top: 20%;
            width: 90%;
            min-height: 30px;
            max-height: 40px;
            margin-left: 5%;*/
            margin-top: 20%;
            width: 80%;
            min-height: 30px;
            max-height: 40px;
            margin-left: 12%;
        }
    </style>
</head>

<body>
    <div class="pin-spinner" style="display:block;">
        <div class="pin-spinner-container pin-spinner-container1">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container2">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container3">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
    </div>
    <div class="autoHeight">

        <div class="weixin_page" style="overflow-y: auto;" >

            <div class="condition_title condition_cursor baindding_offset rowStyle" >

                <input type="text" name="mobile" id="mobile" placeholder="手机号" class="bindMobile" />
                <label style="width:90px;height:32px;"></label>

            </div>

            <div class="condition_title condition_cursor rowStyle baindding_offset" style="margin-top:10%">

                <input type="text" name="verification" id="verification" placeholder="验证码" class="bindMobile"  />
                <input type="button" id="GetVerification" class="bindVerifyBtn" style="padding-top: 0%;" onclick="VerificationClick()" value="获取验证码" />

            </div>

            <div class="baindding_offset">

                <label class="msg MobileModify" style="display: none;margin-left:10px;" id="VerificationMsg"><span id="countdown">60</span>秒后重新发送</label>

            </div>

            <div>
                <button class="wbtn" type="button" onclick="submits()" id="btnNextStep">
                    立即绑定
                </button>
            </div>
        </div>
    </div>

    <footer>
        <div class="bottom-nav" style="bottom:0px;position:fixed;width:100%;">
            <div class="fd-nav">
                <ul>
                    <li>
                        <a onclick="location.href='index.html'" class="logo">
                            <img class="logoimg" style="width: 95%;height: 95%;margin-bottom: 15px;" src="/distributor/image/logo.png" />
                        </a>
                    </li>
                    <li junmo="activity">
                        <a href="javascript:void(0);" class="v1">活动专区</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="suppermarketactivitylist.html" class="on">超惠活动</a></dd>
                                <dd><a href="retaileractivitylist.html" class="">店铺活动</a></dd>
                            </dl>
                        </div>
                    </li>
                    <li junmo="result">
                        <a href="javascript:void(0);" class="v1">销售业绩</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="/distributor/page/employeecustomsendtime.html" class="">推送设置</a></dd>
                                <dd><a href="/distributor/page/salesjobtodaysummary.html">今日统计</a></dd>
                            </dl>
                        </div>

                    </li>
                    <li junmo="mine">
                        <a href="javascript:void(0);" class="v1">我的</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="/distributor/page/bindingmobilemodify.html">手机认证</a></dd>
                                <dd><a href="m-self.html">个人</a></dd>
                                <dd><a href="m-company.html">公司</a></dd>
                            </dl>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </footer>
    <script type="text/javascript">

        $(function () {
            LockButtonStyle(false);//激活按钮
        });

        //获取验证码，60秒倒计时
        function VerificationClick() {

            if (!verifyMobile($('#mobile').val())) {
                changeState("请正确填写您的手机号码", false, false);
                return;
            }
            LockButtonStyle(true);//锁定按钮

            $("#VerificationMsg").show();
            $("#countdown").show();

            $('#countdown').countDown({
                startFontSize: '13px',
                endFontSize: '13px',
                startNumber: 60,
                callBack: function (me) {
                    LockButtonStyle(false);
                }
            });



            $.ajax2({
                type: 'POST',
                dataType: 'json',
                url: '/webapi/distributor/weixin/verifymobilephonebysms',/* 替换API URL */
                data: { mobile: $('#mobile').val() },
                success: function (msg) {
                    $("#btnNextStep").removeAttr("disabled").removeClass("wbtnDisable").addClass("wbtn");
                    $("#btnNextStep").bind("click", function () { submits() });
                }
            });

        }

        function changeState(tipsmsg, statusval, flagloack) {
            toasterextend.showtips(tipsmsg, "error");

            //TODO:如果获取验证码按钮未激活跳转else，增加check
            if (flagloack && $("#GetVerification").hasClass("bindVerifyBtn")) {
                $(".pin-spinner").hide();
                $("#btnNextStep").removeAttr("disabled").removeClass("wbtnDisable").addClass("wbtn");
                $("#btnNextStep").bind("click", function () { submits() });
            }
            else {
                LockButtonStyle(statusval);
            }
        }

        //提交按钮
        function submits() {

            LockButtonStyle(true);

            if ($(this).valid) {
                toasterextend.showtipsautoclose("页面已过期", "warning");
                return;
            }
            if (!verifyMobile($('#mobile').val())) {
                changeState("请正确填写您的手机号码", false, true);
                return;
            }
            if (!checkVerifyCode($("#verification").val())) {
                changeState("请正确填写验证码", false, true);
                return;
            }


            //60秒后重发
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '/webapi/distributor/weixin/bindingmobilephone',/* 替换API URL */
                data: {
                    mobile: $('#mobile').val(),
                    verification: $('#verification').val()
                },
                success: function (msg) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    if (msg.error) {
                        changeState(msg.error, false, true);
                        return;
                    }


                    if (msg.user_notification && msg.user_notification != undefined) {
                        showTips(msg.user_notification, "info");
                        return;
                    }

                    toasterextend.showtipsautoclose("手机号绑定成功！", "success");
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                            errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    //toasterextend.showtips(errormsg, "error");
                    changeState(errormsg, false, true);
                }
            });
        }

        //还原按钮、光标缺省状态
        function LockButtonStyle(cursorState) {
            if (cursorState) {
                $("#GetVerification").attr("disabled", "disabled").removeClass("bindVerifyBtn").addClass("btnDisable");//锁定获取验证码按钮
                $("#GetVerification").unbind();//解绑按钮事件
                $(".pin-spinner").show();
                $("#btnNextStep").attr("disabled", "disabled").removeClass("wbtn").addClass("wbtnDisable");//锁定下一步按钮
                $("#btnNextStep").unbind();
            }
            else {
                $(".pin-spinner").hide();
                $("#btnNextStep").removeAttr("disabled").removeClass("wbtnDisable").addClass("wbtn");
                $("#btnNextStep").bind("click", function () { submits() });

                $("#VerificationMsg").hide();
                $('#countdown').stop();
                $("#countdown").hide().html("60");
                $("#verification").val("");
                $("#GetVerification").removeAttr("disabled").removeClass("btnDisable").addClass("bindVerifyBtn");
                $("#GetVerification").bind("click", function () { VerificationClick() });
            }
        }
    </script>
</body>
</html>
