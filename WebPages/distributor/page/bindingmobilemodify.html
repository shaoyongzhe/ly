<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 ,minimum-scale =1, maximum-scale =1, user-scalable = no" />
    <title>修改绑定手机号</title>
    <link href="/distributor/css/bootstrap.css" rel="stylesheet" />
    <link href="/distributor/css/font-awesome.css" rel="stylesheet" />
    <link href="/distributor/css/jquery-ui.css" rel="stylesheet" />
    <link href="/distributor/css/ace.css" rel="stylesheet" />
    <link href="/distributor/css/style.css" rel="stylesheet" />
    <link href="/distributor/css/weixin.css" rel="stylesheet" />
    <link href="/distributor/css/weixintips.css" rel="stylesheet" />



    <script type="text/javascript" src="/js/jquery/1.11.3/jquery.js"></script>
    <script type="text/javascript" src="/distributor/js/lib/lib.js"> </script>
    <script type="text/javascript" src="/distributor/js/lib/weixintips.js"></script>
    <script type="text/javascript" src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/distributor/js/lib/common-debug.js"></script>
    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/distributor\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" ></script>
    <script type="text/javascript" src="/js/wx/weixinconfiginit-debug.js"></script>

    <style>
        .imgStep {
            margin-left: -12px;
            margin-top: -0px;
            width: 56px;
            height: 56px;
        }

        .resetSend {
            margin-top: 10%;
            width: 92%;
            min-height: 25px;
            max-height: 30px;
            margin-left: 1%;
            text-align: right;
        }
    </style>

</head>

<body>
    <div class="pin-spinner" style="display:block;">
        <div class="pin-spinner-container pin-spinner-container1">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container2">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
        <div class="pin-spinner-container pin-spinner-container3">
            <div class="pin-spinner-circle1"></div>
            <div class="pin-spinner-circle2"></div>
            <div class="pin-spinner-circle3"></div>
            <div class="pin-spinner-circle4"></div>
        </div>
    </div>

    <div class="autoHeight">

        <div class="weixin_page" style="overflow-y: auto;">

            <div class="unselectable" style="text-align:center;margin-top:23%;cursor:default;">

                <div id="step1" class="circle">
                    <img class="imgStep" src="/distributor/image/step-1.png" id="stepc1" />
                </div>
                <label id="stepL1" class="lineA"></label>


                <div id="step2" class="circleB">
                    <img class="imgStep" src="/distributor/image/step-2.png" id="stepc2" />
                </div>
                <label id="stepL2" class="lineB"></label>

                <div id="step3" class="circleB">
                    <img class="imgStep" src="/distributor/image/step-3.png" id="stepc3" />
                </div>
            </div>

            <div class="baindding_offset" style="margin-top: 20%;width: 80%;min-height: 35px;max-height: 50px; margin-left: 12%;">

                <input type="text" id="mobile" placeholder="旧手机号" class="bindMobile" value="" />
                <label class="unselectable mobileModifyHideBtn"> </label>
                <!--</div>

                <div class="condition_title  condition_row baindding_offset ">-->
                <input type="text" id="verifycode" style="margin-top:5%" placeholder="验证码" class="bindMobile" />
                <label id="getVcode" class="bindVerifyBtn" style="">获取验证码</label>
            </div>


            <div class="baindding_offset resetSend">
                <label class="msg MobileModify" style="display:none" id="VerificationMsg"><span id="countdown">60</span>秒后重新获取</label>
            </div>

            <div>
                <button id="btnNextStep" class="wbtnmodify" onclick="NextStep()">下一步</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="bottom-nav" style="bottom:0px;position:fixed;width:100%;">
            <div class="fd-nav">
                <ul>
                    <li>
                        <a onclick="location.href='index.html'" class="logo">
                            <img class="logoimg" style="width: 95%;height: 95%;margin-bottom: 15px;" src="/distributor/image/logo.png" />
                        </a>
                    </li>
                    <li junmo="activity">
                        <a href="javascript:void(0);" class="v1">活动专区</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="suppermarketactivitylist.html" class="on">超惠活动</a></dd>
                                <dd><a href="retaileractivitylist.html" class="">店铺活动</a></dd>
                            </dl>
                        </div>
                    </li>
                    <li junmo="result">
                        <a href="javascript:void(0);" class="v1">销售业绩</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="/distributor/page/employeecustomsendtime.html" class="">推送设置</a></dd>
                                <dd><a href="/distributor/page/salesjobtodaysummary.html">今日统计</a></dd>
                            </dl>
                        </div>

                    </li>
                    <li junmo="mine">
                        <a href="javascript:void(0);" class="v1">我的</a>
                        <div class="sub-nav">
                            <em></em>
                            <dl>
                                <dd><a href="/distributor/page/bindingmobilemodify.html">手机认证</a></dd>
                                <dd><a href="m-self.html">个人</a></dd>
                                <dd><a href="m-company.html">公司</a></dd>
                            </dl>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </footer>

    <script type="text/javascript">

        /*
            1、步骤1、2公用一组样式
            2、加载数据是禁止按钮事件
            3、60″内禁止触发多次获取验证码按钮
            4、步骤二记忆步骤一手机号
            5、
        */


        var oldMobile = ""; //旧手机号
        var oldVcode = "";
        var stepIdx = 1;    //操作步骤

        var varCnum = 60;

        //还原按钮、光标缺省状态 cursorState True: 禁止  False：激活 hideCountdown True:去除旋转动画 False：动画保持原样
        function LockButtonStyle(cursorState, hideCountdown) {
            if (cursorState) {
                $("#getVcode").attr("disabled", "disabled").removeClass("bindVerifyBtn").addClass("bindVerifyDisableBtn");//获取验证码按钮解绑
                $("#getVcode").unbind();

                $("#btnNextStep").attr("disabled", "disabled").removeClass("wbtnmodify").addClass("wbtnDisableModify");//下一步按钮解绑
                $("#btnNextStep").unbind();
            }
            else {
                $("#btnNextStep").removeAttr("disabled").removeClass("wbtnDisableModify").addClass("wbtnmodify");
                $("#btnNextStep").bind("click", function () { NextStep() });

                if (hideCountdown) {
                    $("#VerificationMsg").hide();
                    $('#countdown').stop();
                    $("#countdown").hide().html(varCnum);

                    $("#getVcode").removeAttr("disabled").removeClass("bindVerifyDisableBtn").addClass("bindVerifyBtn");
                    $("#getVcode").bind("click", function () {getVcode($("#getVcode"));});
                }
            }
        }


        //获取验证码，60秒倒计时
        function getVcode() {

            if (!verifyMobile($('#mobile').val())) {

                showTips("请正确填写您的手机号码", "warning");
                LockButtonStyle(false, true);
                return;
            }

            $("#verifycode").text("");

            var webapiurl = "";
            if (stepIdx == 2) {
                webapiurl = '/webapi/distributor/weixin/mobilephonebysms';/* 首次获取验证码 */
            }
            else {
                webapiurl = '/webapi/distributor/weixin/verifymobilephonebysms';/* 第二次获取验证码 */
            }

            LockButtonStyle(true, false);//锁定按钮，下文处理倒计时效果

            var windowWdt = $(window).width();

            if (windowWdt <= 320) {
                $(".resetSend").css({ "margin-left": "1%"});
            }
            else {
                $(".resetSend").css({ "margin-left": "-4%" });
            }

            $("#VerificationMsg").show();
            $("#countdown").show();

            $('#countdown').countDown({
                callBack: function (me) {
                    LockButtonStyle(false, true)//激活按钮，清除倒计时;
                }
            });


            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: webapiurl,
                data: { mobile: $('#mobile').val() },
                beforeSend: function () { $(".pin-spinner").show(); },
                complete: function () { $(".pin-spinner").hide(); },
                success: function (msg) {

                    if (msg.error) {
                        showTips(msg.error, "error");
                        LockButtonStyle(false, true);//激活按钮，清除倒计时
                        return;
                    }
                    else if (msg.user_notification && msg.user_notification != undefined) {

                        showTips(msg.user_notification, "info");
                        //LockButtonStyle(false, false);//激活按钮，清除倒计时

                        $("#btnNextStep").removeAttr("disabled").removeClass("wbtnDisableModify").addClass("wbtnmodify");
                        $("#btnNextStep").bind("click", function () { NextStep() });
                        return;
                    }
                    else {
                        LockButtonStyle(false, false);//激活按钮,倒计时延续
                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $(".pin-spinner").hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }
                    showTips(errormsg, "error");
                    LockButtonStyle(false, true);//激活按钮，清除倒计时
                }
            });
        }

        //请求WebAPI
        function postApi(rUrl, rMobile, rVcode, rNewMobile, rNewVcode) {

            if (!verifyMobile(rMobile)) {

                showTips("请正确填写您的手机号码！", "warning");

                LockButtonStyle(false, true);
                return;
            }
            if (!checkVerifyCode(rVcode)) {

                showTips("请填写有效的验证码！", "warning");

                LockButtonStyle(false, true);
                return;
            }

            LockButtonStyle(true, false);

            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: rUrl,
                data: { mobile: rMobile, verification: rVcode, newmobile: rNewMobile, newVerification: rNewVcode },
                beforeSend: function () { $(".pin-spinner").show(); },
                complete: function () { $(".pin-spinner").hide(); },
                success: function (json) {

                    $(".pin-spinner").hide();//数据请求成功即隐藏转圈动画

                    if (json.error) {
                        showTips(json.error, "error")
                        LockButtonStyle(false, true);
                        return;
                    }

                    if (json.user_notification != undefined) {
                        showTips(json.user_notification, "info");
                        LockButtonStyle(false, false);

                        return;
                    }
                    stepIdx++;
                    stepChange();

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {

                    $(".pin-spinner").hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }
                    showTips(errormsg, "error");
                    LockButtonStyle(false, true);//激活按钮，清除倒计时
                }
            });
        };

        function NextStep() {
            if (stepIdx == 1) {

                oldMobile = $('#mobile').val();
                oldVcode = $('#verifycode').val();

                postApi(
                    '/webapi/distributor/weixin/verifymobilephoneorverification',
                    oldMobile,
                    oldVcode,
                    "",
                    "");
            }
            if (stepIdx == 2) {
                postApi(
                    '/webapi/distributor/weixin/updatemobilephone',
                    oldMobile,
                    oldVcode,
                    $('#mobile').val(),
                    $("#verifycode").val());
            }
        }


        /******************************************************************************************************************/


        function stepChange() {

            if (stepIdx == 3) {

                showTipsAutoClose("新手机认证通过！", "success");
                return;
            }
            else if (stepIdx == 2) {
                /* 第二步 */
                $("#stepL1").removeClass("lineA").addClass("lineC");
                $("#stepL2").removeClass("lineB").addClass("lineA");
                $("#step2").removeClass("circleB").addClass("circle").show();

                $("#verifycode").html("").val("").attr('placeholder', '新验证码');
                $("#mobile").html("").val("").attr('placeholder', '新手机号');
            }
            else {
                /* 返回缺省样式 */
                $("#stepL1").removeClass().addClass("lineA");
                $("#stepL2").removeClass().addClass("lineB");
                $("#step1").removeClass().addClass("circle").show();
                $("#step2").removeClass().addClass("circleB");
                $("#step3").removeClass().addClass("circleB");
                $("#btnNextStep").html("下一步");

                $("#verifycode").html("").val("").attr('placeholder', '验证码');
                $("#mobile").html("").val("").attr('placeholder', '旧手机号');
            }
            LockButtonStyle(false, true);//激活按钮，清除倒计时
        }

        $(function () {
            $(".pin-spinner").hide();

            $(window).on("orientationchange", function () {
                psn = $("#step1").position().left;
            });

            var psn = $("#step1").position().left;

            //stepChange();

            psn = $("#step1").position().left;

            $("#getVcode").bind("click", function () {
                getVcode($("#getVcode"));

            });

            $("#countdown").hide().html(varCnum);

            $.fn.countDown = function (settings, to) {
                settings = $.extend({
                    startFontSize: '13px',
                    endFontSize: '13px',
                    duration: 1000,
                    startNumber: varCnum,
                    endNumber: 0,
                    callBack: function () { }
                }, settings);
                return this.each(function () {

                    //where do we start?
                    if (!to && to != settings.endNumber) { to = settings.startNumber; }

                    //set the countdown to the starting number
                    $(this).text(to).css('fontSize', settings.startFontSize);

                    //loopage
                    $(this).animate({
                        'fontSize': settings.endFontSize
                    }, settings.duration, '', function () {
                        if (to > settings.endNumber + 1) {
                            $(this).css('fontSize', settings.startFontSize).text(to - 1).countDown(settings, to - 1);
                        }
                        else {
                            settings.callBack(this);
                        }
                    });
                });
            };
        });

    </script>
</body>
</html>
