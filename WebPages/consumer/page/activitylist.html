<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 ,minimum-scale =1, maximum-scale =1, user-scalable = no" />
    <meta name="format-detection" content="telephone=no" />

    <title>附近超惠</title>

    <link type="text/css" href="/consumer/css/style.css" rel="stylesheet" />
    <link type="text/css" href="/consumer/css/style1.css" rel="stylesheet" />
    <link href="/consumer/css/weixintips.css" rel="stylesheet" />
    <link type="text/css" href="/consumer/css/qrcode.css" rel="stylesheet" />
    
    <style>
        .storeintro-left {
            padding-right: 46px;
            position: relative;
            box-sizing: border-box;
        }

            .storeintro-left span {
                margin-right: 0px;
                position: absolute;
                right: 0px;
                top: 0;
            }
    </style>
</head>
<body style="padding-bottom:90px;">
    <div class="tip-w">
        <div class="tip"><img src="/consumer/image/icon09.png" /></div>
    </div>
    <div class="active-w ajaxdata" id="list">

    </div>
<footer>
        <div class="space2"></div>
        <div class="share">推荐给朋友 <img src="/consumer/image/icon04.png" /></div>
        <div class="bottomnav">
            <div class="logo"><a href="/consumer/page/index.html"><img src="/consumer/image/logo.png" /></a></div>
            <a href="/consumer/page/retailerlist.html" >
                <div class="nav"><img src="/consumer/image/icon02.png" /><br />附近门店</div>
            </a>
            <a href="/consumer/page/activitylist.html" >
                <div class="nav" style="background:#ff6600;"><img src="/consumer/image/icon03.png" /><br />附近超惠</div>
            </a>
        </div>
    </footer>
	<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
	<script src="http://apps.bdimg.com/libs/jquery-lazyload/1.9.5/jquery.lazyload.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>
    
    <script type="text/javascript" src="/js/jquery/toastr.min.js"></script>
    <script type="text/javascript" src="/js/jquery/utitlity.js"></script>
    <script type="text/javascript" src="/js/wx/configinit.js"></script>
    <script type="text/javascript" src="/js/wx/share.js"></script>
    <script type="text/javascript" src="/js/wx/location.js"></script>


    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/consumer\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script type="text/javascript" src="/consumer/js/lib/common.js"></script>
    <script type="text/javascript" src="/consumer/js/lib/weixintips.js"></script>
    <script type="text/javascript" src="/consumer/js/lib/respond.min.js"></script>
    <script type="text/javascript" src="/consumer/js/lib/jquery-common.js"></script>
    <script type="text/javascript" src="/consumer/js/lib/weixinshare-qrcode.js"></script>
    <script>
        var consumer_id = getUrlParam("consumer_id");

        $(function () {

            $('.tip-w').click(function () {
                $('.tip-w').fadeOut(200);
            })

            $('.share').click(function () {
                $('.tip-w').fadeIn(200);
            })

            //$('.share').click(function () {
            //    $('.tip-w').fadeIn(200).fadeOut(2500);
            //});
            loaddata(wxlocation.latitude, wxlocation.longitude);
                    });
        function loaddata(longitude, latitude) {

            var ajaxdata = { type: "distributor to consumer", consumer_id: consumer_id };
            if (wxjsconfig.sharekey != null)
                ajaxdata[wxjsconfig.sharekey] = "_";            

            var search = window.location.search;
            if (search.length > 0) {
                var keyvalue = [];
                var key = "", value = "";
                var paraString = search.substring(search.indexOf("?") + 1, search.length).split("&");
                for (var i in paraString) {
                    keyvalue = paraString[i].split("=");
                    key = keyvalue[0];
                    value = keyvalue[1];
                    ajaxdata[key] = value;
                }
            }
            if (longitude != undefined && longitude != '' && latitude != undefined && latitude != '') {
                ajaxdata["longitude"] = longitude;
                ajaxdata["latitude"] = latitude
            }
           
            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '/webapi/consumer/weixin/nearby_activity',
                data: ajaxdata,
                beforeSend: function () { common.loading.show(); },
                complete: function () { common.loading.hide(); },
                success: function (jsondata) {

                    common.loading.hide();//数据请求成功即隐藏转圈动画

                    jsondata = jsondata || {};
                    if (jsondata.error) {
                        toasterextend.showtips(jsondata.error, "error", false);
						qrcode.href();
                        return;
                    }

                    if (jsondata.user_notification != undefined) {
                        toasterextend.showtips(jsondata.user_notification, "info");
						qrcode.href();
                        return;
                    }

                    if (jsondata.data == undefined || jsondata.data.length == 0) {
                        $("#list").html(' <img class="lazy" data-original="/consumer/image/acnull.png"  style="width:100%;margin-top:120px;" />');
						qrcode.href();
                        return;
                    }
                    if ($.isFunction(wxjsshare)) {
                        wxjsshare(jsondata.share || {});
                    }

                    var content = "";
                    for (var i = 0; i < jsondata.data.length; i++) {
                        var obj = jsondata.data[i];
                        content += '<a  href="/consumer/page/activityitems.html?activitiy_item_guid=' + obj.guid + '">'
                               + '<div class="prolist">'
                             + '<div class="active-n1 bgwhite"><div class="active-label">'
                             + '<div class="labellist">' + obj.activitykind + '</div></div>'
                             + '<div class="activebox">'
                             + '<div class="activebox-left">'
                             + '<div class="proname fbold">' + obj.activitytitle + '</div>'
                             + '<div class="proinfo">';
                        var productObj = common.product;
                        content += productObj.getActivityKind(obj);
                        var imgUrl;
                        if (obj.itempic != null && obj.itempic.length > 0)
                            imgUrl = obj.itempic;
                        else
                            imgUrl = productObj.imgUrl;

                        content += '</div></div>'
                             + '<div class="activebox-right">'
                             + '<div class="proimgbox">'
                             + '<div class="img"><img class="lazy" data-original="' + imgUrl + '" /></div>'
                             + '<div class="' + productObj.getFlagCss(obj.activity_flag) + '">' + obj.time_to_end_text + '</div></div>'
                             + '</div></div> </div>';
                        if (obj.ruledesc != null && obj.ruledesc.length > 0)
                            content += '<div class="remark"><span>备注：</span>' + obj.ruledesc + '</div>';

                        content += '<div class="storeintro"><div class="storeintro-left">' + obj.retailername + '(' + obj.address + ')<span>' + obj.distance_text + '</span></div>'
                           + '<div class="storeintro-right"><div class="morestore">'
                           + '<div class="img"><img class="lazy" data-original="/consumer/image/icon07.png" /></div><div class="storenum">' + obj.retailer_count + '</div></div></div></div></div></a>';
                    }
                    $("#list").html(content);
					$("img.lazy").lazyload();
                    qrcode.show();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    common.loading.hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                         var json = JSON.parse(XMLHttpRequest.responseText); 				
						 errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
							errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }
					qrcode.href();
                    toasterextend.showtips(errormsg, "error");
                }
            });
        };

    </script>
</body>
</html>
