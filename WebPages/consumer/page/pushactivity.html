<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1 ,minimum-scale =1, maximum-scale =1, user-scalable = no" />
    <meta name="format-detection" content="telephone=no" />

    <title>缤纷福利，新鲜上架!</title>
    <link type="text/css" href="/consumer/css/style_media.css" rel="stylesheet" />
    <link type="text/css" href="/consumer/css/lib.css" rel="stylesheet" />
    <link type="text/css" href="/consumer/css/style1_media.css" rel="stylesheet" />
    <link href="/consumer/css/weixintips.css" rel="stylesheet" />
    <link type="text/css" href="/consumer/css/qrcode.css" rel="stylesheet" />
</head>
<body style="background:#fff;">
    <div class="tip-w">
        <div class="tip"><img src="/consumer/image/icon09.png" /></div>
    </div>
    <div id="list">
    </div>
    <footer>
        <div class="space2"></div>
        <div class="share">推荐给朋友 <img src="/consumer/image/icon07_2.png" /></div>
        <div class="bottomnav">
            <div class="logo1"><a href="/consumer/page/index.html"><img src="/consumer/image/logo.png" /></a></div>
            <a data-original="/consumer/page/retailerlist.html" href="javascript:void(0);">
                <div class="nav" style="background:#ff6600;" href="javascript:void(0);"><img src="/consumer/image/icon02.png" /><br />附近门店</div>
            </a>
            <a data-original="/consumer/page/activitylist.html" href="javascript:void(0);">
                <div class="nav"><img src="/consumer/image/icon03.png" /><br />附近超惠</div>
            </a>
        </div>
    </footer>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
    <script src="http://apps.bdimg.com/libs/jquery-lazyload/1.9.5/jquery.lazyload.min.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js" type="text/javascript"></script>

    <script type="text/javascript" src="/js/jquery/toastr.min.js"></script>
    <script type="text/javascript" src="/js/jquery/utitlity.js"></script>
    <script type="text/javascript" src="/js/wx/configinit.js"></script>
    <script type="text/javascript" src="/js/wx/share.js"></script>
    <script type="text/javascript" src="/js/wx/location.js"></script>

    <script type="text/javascript">document.writeln("<script type=\"text\/javascript\""); document.writeln("src=\"\/webapi\/consumer\/weixin\/jssdk?t=" + new Date().getTime() + "\">"); document.writeln("<\/script>");	</script>
    <script src="/consumer/js/lib/lib.js" type="text/javascript"></script>
    <script src="/consumer/js/lib/weixintips.js"></script>
    <script type="text/javascript" src="/consumer/js/lib/common.js"></script>
    <script type="text/javascript">
        var qrcode = {};
        qrcode.href = function () {
            $("a[data-original]").each(function () {
                var originalurl = $(this).data("original");
                $(this).attr("href", originalurl);
            });
        };
        qrcode.show = function () {
            var original = common.getUrlParam("originalid");
            var qrcode_url = "http://open.weixin.qq.com/qr/code/?username=" + original;
            var qrtemtemplate = [
                '<div class="ewmboxz1-w" id="shareqrcode">',
                '<div class="ewmboxz1">',
                '<img class="ewm" src="' + qrcode_url + '" /><br />',
                '长按上方二维码图片关注超惠买<br />',
                '<img class="adtext1" src="../image/adtext.png" />',
                '</div>',
                '</div>'
            ].join('');
            $("footer").before(qrtemtemplate);
            var shareRegisterPage = "/consumer/page/shareqrcode.html?" + encodeURIComponent(qrcode_url);
            $("a[data-original]").each(function () {
                if ($(this).data("original").indexOf('.html') > -1) {
                    var originalurl = $(this).data("original");
                    $(this).attr("href", wxjsconfig.authurl.replace("__jump__", encodeURIComponent(encodeURIComponent(shareRegisterPage) + "-_-" + originalurl)));
                }
            });

        }
    </script>
    <script src="/consumer/js/cs-danhd-detail.js"></script>
    <script>
        pageType = 1;
        loaddata();
        function loaddata() {

            var ajaxdata = {};
            if (wxjsconfig.sharekey != null)
                ajaxdata[wxjsconfig.sharekey] = "_";
            var search = window.location.search;
            if (search.length > 0) {
                var keyvalue = [];
                var key = "", value = "";
                var paraString = search.substring(search.indexOf("?") + 1, search.length).split("&");
                for (var i in paraString) {
                    keyvalue = paraString[i].split("=");
                    key = keyvalue[0];
                    value = keyvalue[1];
                    ajaxdata[key] = value;
                }
            }

            $.ajax({
                type: 'GET',
                dataType: 'json',
                url: '/webapi/consumer/weixin/shareactivities',
                data: ajaxdata,
                beforeSend: function () { common.loading.show(); },
                complete: function () { common.loading.hide(); },
                success: function (jsondata) {

                    common.loading.hide();//数据请求成功即隐藏转圈动画

                    jsondata = jsondata || {};
                    if (jsondata.error) {
                        toasterextend.showtips(jsondata.error, "error", false);
                        return;
                    }

                    if (jsondata.user_notification != undefined) {
                        toasterextend.showtips(jsondata.user_notification, "info");
                        return;
                    }

                    if (jsondata.data == undefined || jsondata.data.length == 0) {
                        //$("#list").html(' <img src="/consumer/image/acnull.png"  style="width:100%;margin-top:120px;" />');
                        return;
                    }

                    var content = "";
                    for (var i = 0; i < jsondata.data.length; i++) {
                        var obj = jsondata.data[i];
                        var n = obj.items.length;
                        var itemhtml = "";
                        for (var k = 0; k < n; k++)
                            itemhtml += getActItem(obj.items[k]);
                        content += '<div class="duohdbox-w" data-id="duohd_' + obj.activity_id + '">'
                           + '<div class="duohdbox" cls=a> <div class="adimg"><img class="lazy" data-original="' + obj.posterpic + '" /></div>'
                           + '<div class="ceng1"><div class="tit">' + obj.activitytitle + '</div><div class="time">' + obj.begintime + '至' + obj.endtime + '</div>'
                           + '<div class="statebox"><div class="statebtn1">' + common.product.getFlag(obj.activity_flag) + '</div><div class="arrowbottom"><img class="lazy" data-original="/consumer/image/icon10.png" /></div></div></div><div class="ceng2">' + flag + '</div></div>'
                           + '<div class="duohdbox-cont">'
                           + '<div class="dpdetail-info"><div class="hdname">' + obj.activitytitle + '</div><div class="hdtime1"><img class="lazy" data-original="/consumer/image/icon02_2.png" />' + obj.begintime + '至' + obj.endtime + '</div></div>';
                        if (obj.changes != null && obj.changes.length > 0) {
                            content += '<div class="chdetail-textbox">'
                            + '<div class="chtext-tit"><div class="bgline"></div><div class="bgcolor"></div><div class="tit">更正说明</div></div>';
                            for (var j = 0; j < obj.changes.length; j++) {
                                var change = obj.changes[j];
                                content += '<div class="chdetail-cont">' + change.correctdescription + '</div>';
                            }
                            content += '</div>';
                        }

                        content += '<div class="chdetail-textbox" style="padding-top:15px;">'
                        + ' <div class="chtext-tit"><div class="bgline2"></div><div class="bgcolor2"></div><div class="tit">优惠详情</div></div>'
                        + '<ul class="ul-list">' + itemhtml + '</ul>'
                        + '<div class="more-md-w"><div class="more-md">'
                        + '<div class="text">活动共有<span>' + obj.retailer_count + '</span>家门店参加<br />看看有没有您附近的! </div><a data-original="/consumer/page/retailerlist.html"> <div class="btn">点击查看</div></a></div></div>';
                        if (obj.description != '' && obj.description != null) {
                            content += '<div class="chdetail-textbox" style=" border-bottom:1px=border-bottom:1px solid #ccc;">'
                            + '<div class="chtext-tit"><div class="bgline2"></div><div class="bgcolor2"></div><div class="tit">补充信息</div></div><div class="chdetail-cont2">' + obj.description + '</div>'
                            + '</div>';
                        }
                        content += '</div></div></div>';

                    }
                    $("#list").html(content);
                    loadCss();
                    $("img.lazy").lazyload();
                    var wxjsshare = jsondata.share;

                    if (wxjsshare != null) {
                        for (prefix in wxjsshare) {
                            wxjsshare[prefix] = decodeURIComponent(wxjsshare[prefix]);
                        }
                        var shareimg = wxjsconfig.shareimage;
                        if (shareimg == '') {
                            shareimg = wxjsshare.share_imgurl;
                            if (shareimg == '' || shareimg == null) {
                                var imgfirst = $("img[src^='http']");
                                if (imgfirst.length > 0)
                                    shareimg = imgfirst.eq(0).attr("src");
                            }
                        }

                        var sharedesc = wxjsconfig.sharedesc;
                        if (sharedesc == '') {
                            sharedesc = wxjsshare.share_desc;
                            if (sharedesc == '' || sharedesc == undefined) {
                                var metaimgfirst = $("meta[name='description']");
                                if (metaimgfirst.length > 0)
                                    sharedesc = metaimgfirst.eq(0).attr("content");
                            }
                        }

                        var sharetitle = wxjsconfig.sharetitle;
                        if (sharetitle == '' || sharetitle == undefined) {
                            sharetitle = wxjsshare.share_title;
                            if (sharetitle == '' || sharetitle == undefined) {
                                sharetitle = document.title;
                            }
                        }

                        var jsonShare = {
                            title: sharetitle,
                            desc: sharedesc,//wxjssharedesc,
                            link: document.URL,
                            imgUrl: shareimg,//wxjsshareimage,
                            trigger: function (res) {
                                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
                            },
                            success: function (res) {
                            },
                            cancel: function (res) {
                            },
                            fail: function (res) {
                            }
                        };

                        wx.ready(function () {
                            wxjsconfig.menuitems = wxjsconfig.menuitems || [];
                            if (wxjsconfig.menuitems.length == 0) {
                                return;
                            }
                            wx.showMenuItems({
                                menuList: wxjsconfig.menuitems,
                                success: function (res) {
                                },
                                fail: function (res) {
                                }
                            });
                            $.each(wxjsconfig.menuitems, function (i, item) {
                                switch (item) {
                                    case "menuItem:share:appMessage":
                                        wx.onMenuShareAppMessage(jsonShare);
                                        break;
                                    case "menuItem:share:timeline":
                                        wx.onMenuShareTimeline(jsonShare);
                                        break;
                                    case "menuItem:share:qq":
                                        wx.onMenuShareQQ(jsonShare);
                                        break;
                                    case "menuItem:share:weiboApp":
                                        wx.onMenuShareWeibo(jsonShare);
                                        break;
                                    case "menuItem:share:QZone":
                                        wx.onMenuShareQZone(jsonShare);
                                        break;
                                    default:
                                        break;
                                }
                            });
                        });



                    }
                    qrcode.show();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    common.loading.hide();//隐藏转圈动画

                    var errormsg = "访问异常";

                    if (XMLHttpRequest.status != null && XMLHttpRequest.status != 200) {
                        var json = JSON.parse(XMLHttpRequest.responseText);
                        errormsg = JSON.parse(json.Message).error;
                        if (errormsg == undefined || errormsg == '')
                            errormsg = "Http error: " + XMLHttpRequest.statusText;
                    }

                    toasterextend.showtips(errormsg, "error");
                }
            });

        };


        function loadCss() {
            var $divWidth = $('.duohdbox').width();
            $('.duohdbox').css({ 'height': $divWidth * 3 / 4 });

            $('.tip-w').click(function () {
                $('.tip-w').fadeOut(200);
            })

            $('.share').click(function () {
                $('.tip-w').fadeIn(200);
            })

            //$('.share').click(function () {
            //    $('.tip-w').fadeIn(200).fadeOut(2500);
            //})
            $('.duohdbox').click(function () {
                if ($(this).attr('cls') == 'a') {
                    $('.duohdbox-cont').hide();
                    $('.duohdbox').children('.ceng1').show();
                    $('.duohdbox').children('.ceng2').hide();
                    $('.duohdbox').css('padding', '10px');
                    $('.duohdbox').children('.adimg').css('border-radius', '5px');
                    $('.duohdbox').attr('cls', 'a');


                    $(this).next('.duohdbox-cont').show();
                    $(this).children('.ceng1').hide();
                    $(this).children('.ceng2').show();
                    $(this).css('padding', '0px')
                    $(this).children('.adimg').css('border-radius', '0px')
                    $(this).attr('cls', 'b');
                    $("html,body").animate({ scrollTop: $(this).offset().top }, 0);


                } else {
                    $('.duohdbox-cont').hide();
                    $('.duohdbox').children('.ceng1').show();
                    $('.duohdbox').children('.ceng2').hide();
                    $('.duohdbox').css('padding', '10px');
                    $('.duohdbox').children('.adimg').css('border-radius', '5px');
                    $('.duohdbox').attr('cls', 'a');

                    $(this).next('.duohdbox-cont').hide();
                    $(this).children('.ceng1').show();
                    $(this).css('padding', '10px');
                    $(this).children('.adimg').css('border-radius', '5px');
                    $(this).children('.ceng2').hide();
                }
            })
        }

    </script>
</body>
</html>
